# è½»é‡çº§å†…ç½‘éš§é“

ä¸€ä¸ªä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„è½»é‡çº§å†…ç½‘éš§é“å·¥å…·ï¼Œä½¿ç”¨ **UDP ä¼ è¾“å¹¶æ·»åŠ ä¼ªè£… TCP å¤´éƒ¨**æ¥ç»•è¿‡é˜²ç«å¢™ï¼ŒåŒæ—¶æ”¯æŒ **AES-256-GCM åŠ å¯†**å’Œ FEC çº é”™åŠŸèƒ½ï¼Œé€‚ç”¨äºåœ¨å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´å»ºç«‹å®‰å…¨çš„è™šæ‹Ÿå†…ç½‘è¿æ¥ã€‚

## ä¸»è¦ç‰¹æ€§

- ğŸš€ **è½»é‡é«˜æ•ˆ** - èµ„æºå ç”¨å°‘ï¼Œé€‚åˆä½é…ç½®æœåŠ¡å™¨
- ğŸ” **AES-256-GCM åŠ å¯†** - ä½¿ç”¨ `-k` å‚æ•°å¯ç”¨åŠ å¯†ï¼Œé˜²æ­¢æœªæˆæƒè¿æ¥
- ğŸ­ **TCP ä¼ªè£…** - UDP æ•°æ®åŒ…ä¼ªè£…æˆ TCP è¿æ¥ï¼Œå¯ç©¿é€é˜²ç«å¢™
- âš¡ **UDP ä¼ è¾“** - å®é™…ä½¿ç”¨ UDP ä¼ è¾“ï¼Œé¿å… TCP-over-TCP é—®é¢˜
- ğŸ›¡ï¸ **FEC çº é”™** - è‡ªåŠ¨çº æ­£ä¸¢åŒ…ï¼Œæå‡å¼±ç½‘ç¯å¢ƒä¸‹çš„ç¨³å®šæ€§
- ğŸŒ **å¤šå®¢æˆ·ç«¯** - æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥ï¼Œå®¢æˆ·ç«¯ä¹‹é—´å¯äº’ç›¸é€šä¿¡
- ğŸ”„ **P2P ç›´è¿** - æ”¯æŒå®¢æˆ·ç«¯ä¹‹é—´ P2P ç›´æ¥è¿æ¥ï¼Œæ— éœ€æœåŠ¡å™¨ä¸­è½¬
- ğŸ§  **æ™ºèƒ½è·¯ç”±** - è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è·¯å¾„ï¼šP2Pã€ä¸­ç»§æˆ–æœåŠ¡å™¨è½¬å‘
- ğŸŒ **ç½‘çŠ¶ç½‘ç»œ** - æ”¯æŒé€šè¿‡å…¶ä»–å®¢æˆ·ç«¯ä¸­ç»§æµé‡ï¼Œå®ç°å¤šè·³è½¬å‘
- âš¡ **é«˜æ€§èƒ½** - åŸºäº Go åç¨‹å®ç°é«˜å¹¶å‘å¤„ç†
- ğŸ¯ **ç®€å•æ˜“ç”¨** - æ”¯æŒå‘½ä»¤è¡Œå’Œé…ç½®æ–‡ä»¶ä¸¤ç§æ–¹å¼

## ğŸ” å®‰å…¨è¯´æ˜

### æ¨èï¼šä½¿ç”¨ `-k` å‚æ•°åŠ å¯†

ä½¿ç”¨ `-k` å‚æ•°å¯ä»¥å¯ç”¨ **AES-256-GCM åŠ å¯†**ï¼Œè¿™æ˜¯æ¨èçš„å®‰å…¨é…ç½®ï¼š

```bash
# æœåŠ¡ç«¯ï¼ˆå¯ç”¨åŠ å¯†ï¼‰
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24 -k "your-secret-key"

# å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨ç›¸åŒå¯†é’¥ï¼‰
sudo ./lightweight-tunnel -m client -r <æœåŠ¡å™¨IP>:9000 -t 10.0.0.2/24 -k "your-secret-key"
```

**åŠ å¯†çš„ä¼˜åŠ¿ï¼š**
- âœ… æ‰€æœ‰éš§é“æµé‡ï¼ˆåŒ…æ‹¬ P2Pï¼‰éƒ½ä¼šè¢«åŠ å¯†
- âœ… é˜²æ­¢æœªæˆæƒç”¨æˆ·è¿æ¥åˆ°æ‚¨çš„éš§é“
- âœ… é˜²æ­¢ä¸­é—´äººæ”»å‡»å’Œæµé‡çªƒå¬
- âœ… å¯†é’¥ä¸åŒ¹é…çš„è¿æ¥ä¼šè¢«è‡ªåŠ¨æ‹’ç»

**æ³¨æ„ï¼š** æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ï¼Œå¦åˆ™æ— æ³•é€šä¿¡ã€‚

### æ— åŠ å¯†æ¨¡å¼ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰

å¦‚æœä¸ä½¿ç”¨ `-k` å‚æ•°ï¼Œéš§é“å°†ä¸åŠ å¯†ï¼Œ**ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨**ï¼š

```bash
# âš ï¸ è­¦å‘Šï¼šæ­¤æ¨¡å¼æ— åŠ å¯†ï¼Œä»…ç”¨äºæµ‹è¯•
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24
```

è¯¦è§ [SECURITY.md](SECURITY.md)ã€‚

## å¿«é€Ÿå¼€å§‹

### ç³»ç»Ÿè¦æ±‚

- Linux ç³»ç»Ÿï¼ˆéœ€è¦ TUN è®¾å¤‡æ”¯æŒï¼‰
- Root æƒé™ï¼ˆç”¨äºåˆ›å»ºå’Œé…ç½® TUN è®¾å¤‡ï¼‰
- Go 1.19+ ï¼ˆä»…ç¼–è¯‘æ—¶éœ€è¦ï¼‰

### å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/openbmx/lightweight-tunnel.git
cd lightweight-tunnel

# ç¼–è¯‘
go build -o lightweight-tunnel ./cmd/lightweight-tunnel

# æˆ–è€…ç›´æ¥å®‰è£…
go install ./cmd/lightweight-tunnel
```

### ä½œä¸ºç³»ç»ŸæœåŠ¡è¿è¡Œï¼ˆå¼€æœºè‡ªå¯ï¼‰

> æç¤ºï¼šå®‰è£… systemd æœåŠ¡æ—¶ä¼šæŠŠ **å½“å‰äºŒè¿›åˆ¶çš„ç»å¯¹è·¯å¾„** å’Œ **æŒ‡å®šçš„é…ç½®æ–‡ä»¶è·¯å¾„** å†™å…¥å•å…ƒæ–‡ä»¶ï¼Œå®‰è£…åå¦‚æœç§»åŠ¨äºŒè¿›åˆ¶æˆ–é…ç½®æ–‡ä»¶ï¼Œè¯·é‡æ–°æ‰§è¡Œå®‰è£…å‘½ä»¤ã€‚

```bash
# 1) å°†äºŒè¿›åˆ¶æ”¾åˆ°å›ºå®šè·¯å¾„ï¼ˆæ¨è /usr/local/binï¼‰
go build -o lightweight-tunnel ./cmd/lightweight-tunnel
sudo install -m 755 ./lightweight-tunnel /usr/local/bin/lightweight-tunnel

# 2) å‡†å¤‡é…ç½®ï¼ˆç¤ºä¾‹è·¯å¾„ï¼Œéœ€ rootï¼‰
sudo mkdir -p /etc/lightweight-tunnel
sudo /usr/local/bin/lightweight-tunnel -g /etc/lightweight-tunnel/config.json

# 3) å®‰è£…å¹¶å¯åŠ¨ systemd æœåŠ¡ï¼ˆç»‘å®šæŒ‡å®šé…ç½®ï¼‰
sudo /usr/local/bin/lightweight-tunnel -service install -c /etc/lightweight-tunnel/config.json
#    å¯é€‰ï¼šè‡ªå®šä¹‰æœåŠ¡åä¸é…ç½®è·¯å¾„
# sudo /usr/local/bin/lightweight-tunnel -service install \\
#      -service-name tunnel-a \\
#      -c /etc/lightweight-tunnel/tunnel-a.json   # æˆ– -service-config /etc/lightweight-tunnel/tunnel-a.json

# 4) æ§åˆ¶å‘½ä»¤
sudo /usr/local/bin/lightweight-tunnel -service status
sudo /usr/local/bin/lightweight-tunnel -service restart
sudo /usr/local/bin/lightweight-tunnel -service uninstall   # éœ€è¦æ—¶ç§»é™¤æœåŠ¡
```

è¯´æ˜ï¼š
- `-service install` ä¼šåœ¨ `/etc/systemd/system/<æœåŠ¡å>.service` ä¸­å†™å…¥ ExecStart ä¸é…ç½®è·¯å¾„ï¼›äºŒè¿›åˆ¶æˆ–é…ç½®ç§»åŠ¨åéœ€é‡æ–°å®‰è£…æœåŠ¡ã€‚
- é»˜è®¤æœåŠ¡åä¸º `lightweight-tunnel.service`ï¼Œå¯é€šè¿‡ `-service-name <name>` è‡ªå®šä¹‰ï¼Œå¤šéš§é“éƒ¨ç½²æ—¶ä¸ºæ¯ä¸ªé…ç½®æŒ‡å®šä¸åŒåç§°ã€‚
- é…ç½®æ–‡ä»¶åå¯è‡ªå®šä¹‰ï¼Œé€šè¿‡ `-service-config <path>` æˆ– `-c <path>` æŒ‡å®šä»»æ„è·¯å¾„å’Œæ–‡ä»¶åï¼Œæœªæ˜¾å¼æŒ‡å®šæ—¶é»˜è®¤ `/etc/lightweight-tunnel/config.json`ã€‚
- é…ç½®æ›´æ–°åæ‰§è¡Œ `sudo systemctl restart <æœåŠ¡å>` ç”Ÿæ•ˆï¼Œå¯ç”¨ `journalctl -u <æœåŠ¡å> -f` æŸ¥çœ‹è¿è¡Œæ—¥å¿—ã€‚

### åŸºæœ¬ä½¿ç”¨

#### åœºæ™¯ä¸€ï¼šå¸¦åŠ å¯†çš„å®‰å…¨éš§é“ï¼ˆæ¨èï¼‰

**æœåŠ¡ç«¯ï¼š**
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24 -k "my-secret-key"
```

**å®¢æˆ·ç«¯ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r <æœåŠ¡å™¨IP>:9000 -t 10.0.0.2/24 -k "my-secret-key"
```

**æµ‹è¯•è¿æ¥ï¼š**
```bash
# åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ
ping 10.0.0.1
```

#### åœºæ™¯äºŒï¼šç®€å•çš„ç‚¹å¯¹ç‚¹è¿æ¥ï¼ˆä»…æµ‹è¯•ç”¨ï¼Œæ— åŠ å¯†ï¼‰

**æœåŠ¡ç«¯ï¼š**
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24
```

**å®¢æˆ·ç«¯ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r <æœåŠ¡å™¨IP>:9000 -t 10.0.0.2/24
```

**âš ï¸ æ³¨æ„ï¼š** æ­¤æ¨¡å¼ä¸‹æµé‡æœªåŠ å¯†ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¿æ¥ã€‚ä»…å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä½¿ç”¨ã€‚

#### åœºæ™¯ä¸‰ï¼šå¤šå®¢æˆ·ç«¯ç»„ç½‘ï¼ˆå¸¦åŠ å¯†ï¼‰

æœåŠ¡ç«¯é»˜è®¤æ”¯æŒå¤šå®¢æˆ·ç«¯è¿æ¥ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å¯ä»¥äº’ç›¸é€šä¿¡ï¼š

**æœåŠ¡ç«¯ï¼š**
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24 -k "shared-secret"
```

**å®¢æˆ·ç«¯ 1ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r <æœåŠ¡å™¨IP>:9000 -t 10.0.0.2/24 -k "shared-secret"
```

**å®¢æˆ·ç«¯ 2ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r <æœåŠ¡å™¨IP>:9000 -t 10.0.0.3/24 -k "shared-secret"
```

**å®¢æˆ·ç«¯ 3ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r <æœåŠ¡å™¨IP>:9000 -t 10.0.0.4/24 -k "shared-secret"
```

è¿æ¥åï¼Œå®¢æˆ·ç«¯ä¹‹é—´å¯ä»¥ç›´æ¥é€šä¿¡ï¼š
```bash
# åœ¨å®¢æˆ·ç«¯ 1 ä¸Š ping å®¢æˆ·ç«¯ 2
ping 10.0.0.3

# åœ¨å®¢æˆ·ç«¯ 1 ä¸Š SSH åˆ°å®¢æˆ·ç«¯ 3
ssh user@10.0.0.4
```

#### åœºæ™¯å››ï¼šP2P ç›´è¿æ¨¡å¼ï¼ˆå¸¦åŠ å¯†ï¼‰

å¯ç”¨ P2P æ¨¡å¼ï¼Œå®¢æˆ·ç«¯ä¹‹é—´ä¼šè‡ªåŠ¨å°è¯•å»ºç«‹ç›´æ¥è¿æ¥ï¼Œæ— éœ€é€šè¿‡æœåŠ¡å™¨ä¸­è½¬ã€‚P2P æµé‡åŒæ ·ä¼šè¢«åŠ å¯†ï¼š

**æœåŠ¡ç«¯ï¼š**
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24 -k "p2p-secret"
```

**å®¢æˆ·ç«¯ 1ï¼ˆå¯ç”¨ P2Pï¼‰ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r <æœåŠ¡å™¨IP>:9000 -t 10.0.0.2/24 -p2p -k "p2p-secret"
```

**å®¢æˆ·ç«¯ 2ï¼ˆå¯ç”¨ P2Pï¼‰ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r <æœåŠ¡å™¨IP>:9000 -t 10.0.0.3/24 -p2p -k "p2p-secret"
```

P2P è¿æ¥å»ºç«‹åï¼š
- æµé‡ç›´æ¥åœ¨å®¢æˆ·ç«¯ä¹‹é—´ä¼ è¾“ï¼Œå»¶è¿Ÿæ›´ä½
- **æ‰€æœ‰ P2P æµé‡éƒ½ä¼šè¢«åŠ å¯†**
- å‡å°‘æœåŠ¡å™¨å¸¦å®½å’Œ CPU è´Ÿè½½
- P2P å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æœåŠ¡å™¨è½¬å‘

**æŸ¥çœ‹è·¯ç”±çŠ¶æ€ï¼š**
```bash
# æ—¥å¿—ä¼šæ˜¾ç¤ºè·¯ç”±ç»Ÿè®¡
Routing stats: 2 peers, 1 direct, 0 relay, 1 server
# è¡¨ç¤ºï¼š2ä¸ªå¯¹ç­‰èŠ‚ç‚¹ï¼Œ1ä¸ªP2Pç›´è¿ï¼Œ0ä¸ªä¸­ç»§ï¼Œ1ä¸ªæœåŠ¡å™¨è·¯ç”±
```

è¯¦ç»†æ–‡æ¡£è¯·å‚é˜…ï¼š[P2P_ROUTING.md](P2P_ROUTING.md)

### ä½¿ç”¨é…ç½®æ–‡ä»¶

#### ç”Ÿæˆç¤ºä¾‹é…ç½®

```bash
./lightweight-tunnel -g config.json
# ä¼šç”Ÿæˆ config.jsonï¼ˆæœåŠ¡ç«¯ï¼‰å’Œ config.json.clientï¼ˆå®¢æˆ·ç«¯ï¼‰
```

#### æœåŠ¡ç«¯é…ç½®ç¤ºä¾‹

```json
{
  "mode": "server",
  "local_addr": "0.0.0.0:9000",
  "tunnel_addr": "10.0.0.1/24",
  "key": "your-secret-key",
  "mtu": 1400,
  "fec_data": 10,
  "fec_parity": 3,
  "timeout": 30,
  "keepalive": 10,
  "send_queue_size": 1000,
  "recv_queue_size": 1000,
  "multi_client": true,
  "max_clients": 100,
  "client_isolation": false
}
```

**é‡è¦è¯´æ˜ï¼š**
- `key`ï¼šåŠ å¯†å¯†é’¥ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»ç›¸åŒ
- `multi_client`ï¼šæœªæŒ‡å®šæ—¶é»˜è®¤ä¸º `true`ï¼Œå…è®¸å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥
- å¦‚éœ€é™åˆ¶ä¸ºå•å®¢æˆ·ç«¯æ¨¡å¼ï¼Œæ˜¾å¼è®¾ç½®ä¸º `false`

#### å®¢æˆ·ç«¯é…ç½®ç¤ºä¾‹

```json
{
  "mode": "client",
  "remote_addr": "<æœåŠ¡å™¨IP>:9000",
  "tunnel_addr": "10.0.0.2/24",
  "key": "your-secret-key",
  "mtu": 1400,
  "fec_data": 10,
  "fec_parity": 3,
  "timeout": 30,
  "keepalive": 10,
  "send_queue_size": 1000,
  "recv_queue_size": 1000,
  "p2p_enabled": true,
  "p2p_port": 0,
  "enable_mesh_routing": true,
  "max_hops": 3,
  "route_update_interval": 30
}
```

**åŠ å¯†é…ç½®è¯´æ˜ï¼š**
- `key`ï¼šåŠ å¯†å¯†é’¥ï¼Œå¿…é¡»ä¸æœåŠ¡ç«¯ç›¸åŒ

**P2P é…ç½®è¯´æ˜ï¼š**
- `p2p_enabled`ï¼šå¯ç”¨ P2P ç›´è¿ï¼ˆé»˜è®¤ï¼štrueï¼‰
- `p2p_port`ï¼šUDP ç«¯å£ï¼Œ0 è¡¨ç¤ºè‡ªåŠ¨é€‰æ‹©
- `enable_mesh_routing`ï¼šå¯ç”¨ç½‘çŠ¶è·¯ç”±ï¼ˆé»˜è®¤ï¼štrueï¼‰
- `max_hops`ï¼šæœ€å¤§è·³æ•°ï¼ˆé»˜è®¤ï¼š3ï¼‰
- `route_update_interval`ï¼šè·¯ç”±æ›´æ–°é—´éš”ç§’æ•°ï¼ˆé»˜è®¤ï¼š30ï¼‰

#### ä½¿ç”¨é…ç½®æ–‡ä»¶è¿è¡Œ

```bash
sudo ./lightweight-tunnel -c config.json
```

## é…ç½®è¯´æ˜

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `-c` | é…ç½®æ–‡ä»¶è·¯å¾„ | - |
| `-m` | æ¨¡å¼ï¼šserver æˆ– client | server |
| `-l` | ç›‘å¬åœ°å€ï¼ˆæœåŠ¡ç«¯ï¼‰ | 0.0.0.0:9000 |
| `-r` | æœåŠ¡å™¨åœ°å€ï¼ˆå®¢æˆ·ç«¯ï¼‰ | - |
| `-t` | éš§é“ IP åœ°å€å’Œå­ç½‘æ©ç  | 10.0.0.1/24 |
| `-k` | **åŠ å¯†å¯†é’¥**ï¼ˆæ¨èä½¿ç”¨ï¼‰ | - |
| `-mtu` | MTU å¤§å° | 1400 |
| `-fec-data` | FEC æ•°æ®åˆ†ç‰‡æ•° | 10 |
| `-fec-parity` | FEC æ ¡éªŒåˆ†ç‰‡æ•° | 3 |
| `-send-queue` | å‘é€é˜Ÿåˆ—å¤§å° | 1000 |
| `-recv-queue` | æ¥æ”¶é˜Ÿåˆ—å¤§å° | 1000 |
| `-multi-client` | å¯ç”¨å¤šå®¢æˆ·ç«¯æ”¯æŒï¼ˆæœåŠ¡ç«¯ï¼‰ | true |
| `-max-clients` | æœ€å¤§å®¢æˆ·ç«¯æ•°é‡ï¼ˆæœåŠ¡ç«¯ï¼‰ | 100 |
| `-client-isolation` | å®¢æˆ·ç«¯éš”ç¦»æ¨¡å¼ | false |
| `-p2p` | å¯ç”¨ P2P ç›´è¿ | true |
| `-p2p-port` | P2P UDP ç«¯å£ï¼ˆ0=è‡ªåŠ¨ï¼‰ | 0 |
| `-mesh-routing` | å¯ç”¨ç½‘çŠ¶è·¯ç”± | true |
| `-max-hops` | æœ€å¤§è·³æ•° | 3 |
| `-route-update` | è·¯ç”±æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰ | 30 |
| `-tls` | å¯ç”¨ TLS åŠ å¯†ï¼ˆä¸æ¨èï¼Œå› ä¸ºä½¿ç”¨ UDPï¼‰ | false |
| `-tls-cert` | TLS è¯ä¹¦æ–‡ä»¶ï¼ˆæœåŠ¡ç«¯ï¼‰ | - |
| `-tls-key` | TLS ç§é’¥æ–‡ä»¶ï¼ˆæœåŠ¡ç«¯ï¼‰ | - |
| `-tls-skip-verify` | è·³è¿‡è¯ä¹¦éªŒè¯ï¼ˆå®¢æˆ·ç«¯ï¼Œä¸å®‰å…¨ï¼‰ | false |
| `-tun` | æŒ‡å®š TUN è®¾å¤‡åï¼ˆä¸ºç©ºåˆ™è‡ªåŠ¨åˆ†é… tun0ã€tun1...ï¼‰ | - |
| `-service` | systemd æœåŠ¡æ“ä½œï¼šinstall/uninstall/start/stop/restart/status | - |
| `-service-name` | systemd æœåŠ¡å | lightweight-tunnel |
| `-service-config` | å®‰è£…/æ§åˆ¶æœåŠ¡ä½¿ç”¨çš„é…ç½®æ–‡ä»¶è·¯å¾„ | /etc/lightweight-tunnel/config.json |
| `-v` | æ˜¾ç¤ºç‰ˆæœ¬ | - |
| `-g` | ç”Ÿæˆç¤ºä¾‹é…ç½®æ–‡ä»¶ | - |

### å¤šå®¢æˆ·ç«¯é…ç½®é€‰é¡¹

**Hub æ¨¡å¼ï¼ˆé»˜è®¤ï¼Œæ¨èå¸¦åŠ å¯†ï¼‰ï¼š** æ‰€æœ‰å®¢æˆ·ç«¯å¯ä»¥äº’ç›¸é€šä¿¡
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24 -k "my-key"
```

**å®¢æˆ·ç«¯éš”ç¦»æ¨¡å¼ï¼š** å®¢æˆ·ç«¯åªèƒ½ä¸æœåŠ¡ç«¯é€šä¿¡ï¼Œä¸èƒ½äº’è®¿
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24 -k "my-key" -client-isolation
```

**å•å®¢æˆ·ç«¯æ¨¡å¼ï¼š** åªå…è®¸ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24 -k "my-key" -multi-client=false
```

## æ€§èƒ½è°ƒä¼˜

### é«˜é€Ÿç½‘ç»œç¯å¢ƒ

```bash
# å¢å¤§ MTU
sudo ./lightweight-tunnel -mtu 8000 ...

# å‡å°‘ FEC å¼€é”€
sudo ./lightweight-tunnel -fec-data 20 -fec-parity 2 ...
```

### é«˜ä¸¢åŒ…ç½‘ç»œç¯å¢ƒ

```bash
# å¢åŠ  FEC å†—ä½™
sudo ./lightweight-tunnel -fec-data 10 -fec-parity 5 ...

# å‡å° MTU
sudo ./lightweight-tunnel -mtu 1200 ...
```

### é«˜å¸¦å®½åœºæ™¯

å¦‚æœçœ‹åˆ° "Send queue full, dropping packet" é”™è¯¯ï¼Œå¢å¤§é˜Ÿåˆ—ï¼š
```bash
sudo ./lightweight-tunnel -send-queue 5000 -recv-queue 5000 ...
```

å»ºè®®å€¼ï¼š
- æ™®é€šä½¿ç”¨ï¼š1000-5000
- é«˜å¸¦å®½éš§é“ï¼š5000-10000

## å¸¸è§é—®é¢˜

### æƒé™é”™è¯¯

**é—®é¢˜ï¼š** `failed to open /dev/net/tun: permission denied`

**è§£å†³ï¼š** ä½¿ç”¨ root æƒé™è¿è¡Œ
```bash
sudo ./lightweight-tunnel ...
```

### TUN è®¾å¤‡ä¸å­˜åœ¨

**é—®é¢˜ï¼š** `/dev/net/tun: no such file or directory`

**è§£å†³ï¼š** åŠ è½½ TUN æ¨¡å—
```bash
sudo modprobe tun
```

### æ— æ³•è¿æ¥æœåŠ¡å™¨

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥æœåŠ¡ç«¯æ˜¯å¦è¿è¡Œï¼š`netstat -tlnp | grep 9000`
2. æ£€æŸ¥é˜²ç«å¢™ï¼š`sudo ufw allow 9000/tcp`
3. éªŒè¯æœåŠ¡å™¨ IP åœ°å€æ˜¯å¦æ­£ç¡®
4. æµ‹è¯•ç½‘ç»œè¿é€šæ€§ï¼š`ping <æœåŠ¡å™¨IP>`

### ç¬¬äºŒä¸ªå®¢æˆ·ç«¯è¿æ¥å¤±è´¥ï¼ˆEOF/Broken Pipeï¼‰

**é—®é¢˜ï¼š** ç¬¬äºŒä¸ªå®¢æˆ·ç«¯æŠ¥é”™ "Network read error: EOF" æˆ– "write: broken pipe"

**åŸå› ï¼š** æœåŠ¡ç«¯é…ç½®ä¸ºå•å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆ`multi_client: false`ï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**

ä½¿ç”¨ JSON é…ç½®æ–‡ä»¶æ—¶ï¼š
```json
{
  "mode": "server",
  "local_addr": "0.0.0.0:9000",
  "tunnel_addr": "10.0.0.1/24",
  "multi_client": true,
  "max_clients": 100
}
```

ä½¿ç”¨å‘½ä»¤è¡Œæ—¶ï¼ˆé»˜è®¤å·²å¯ç”¨ï¼‰ï¼š
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24
```

### å¯†é’¥ä¸åŒ¹é…å¯¼è‡´è§£å¯†å¤±è´¥

**é—®é¢˜ï¼š** æ—¥å¿—æ˜¾ç¤º "Decryption error (wrong key?)"

**åŸå› ï¼š** æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä½¿ç”¨äº†ä¸åŒçš„åŠ å¯†å¯†é’¥

**è§£å†³æ–¹æ¡ˆï¼š** ç¡®ä¿æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä½¿ç”¨å®Œå…¨ç›¸åŒçš„ `-k` å‚æ•°å€¼

```bash
# æœåŠ¡ç«¯
sudo ./lightweight-tunnel -m server -k "same-key" ...

# å®¢æˆ·ç«¯
sudo ./lightweight-tunnel -m client -k "same-key" ...
```

### ç«¯å£è¢«å ç”¨

**é—®é¢˜ï¼š** `bind: address already in use`

**è§£å†³ï¼š** æŸ¥æ‰¾å¹¶å…³é—­å ç”¨ç«¯å£çš„è¿›ç¨‹
```bash
# æŸ¥æ‰¾è¿›ç¨‹
sudo lsof -i :9000

# ç»ˆæ­¢è¿›ç¨‹
sudo kill -9 PID
```

## å·¥ä½œåŸç†

1. **TUN è®¾å¤‡ï¼š** åˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œå¤„ç†ä¸‰å±‚ IP æ•°æ®åŒ…
2. **UDP ä¼ è¾“ï¼š** ä½¿ç”¨ UDP ä½œä¸ºå®é™…ä¼ è¾“åè®®ï¼Œé¿å… TCP-over-TCP é—®é¢˜
3. **TCP ä¼ªè£…ï¼š** åœ¨ UDP åŒ…å¤–æ·»åŠ ä¼ªè£…çš„ TCP å¤´éƒ¨ï¼Œç©¿é€é˜²ç«å¢™ï¼ˆä»…é™æœåŠ¡å™¨éš§é“ï¼‰
4. **AES-256-GCM åŠ å¯†ï¼š** ä½¿ç”¨ `-k` å‚æ•°å¯ç”¨ï¼ŒåŠ å¯†æ‰€æœ‰éš§é“æµé‡ï¼ˆåŒ…æ‹¬ P2Pï¼‰
5. **FEC çº é”™ï¼š** æ·»åŠ å†—ä½™æ•°æ®åˆ†ç‰‡ï¼Œè‡ªåŠ¨æ¢å¤ä¸¢å¤±çš„æ•°æ®åŒ…
6. **ä¿æ´»æœºåˆ¶ï¼š** å®šæœŸå‘é€å¿ƒè·³åŒ…ç»´æŒè¿æ¥
7. **P2P ç›´è¿ï¼š** ä½¿ç”¨ UDP æ‰“æ´æŠ€æœ¯å»ºç«‹å®¢æˆ·ç«¯ä¹‹é—´çš„ç›´æ¥è¿æ¥
8. **æ™ºèƒ½è·¯ç”±ï¼š** æ ¹æ®è¿æ¥è´¨é‡è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è·¯å¾„ï¼ˆP2P/ä¸­ç»§/æœåŠ¡å™¨ï¼‰

## æŠ€æœ¯åŸç†

### UDP + ä¼ªè£… TCP å¤´éƒ¨

æœ¬é¡¹ç›®çš„æ ¸å¿ƒè®¾è®¡å€Ÿé‰´äº† **udp2raw** å’Œ **tinyfecVPN**ï¼š

- **å®é™…ä¼ è¾“ï¼š** UDPï¼ˆé¿å… TCP-over-TCP æ€§èƒ½é—®é¢˜ï¼‰
- **å¤–è§‚ä¼ªè£…ï¼š** æ·»åŠ  TCP å¤´éƒ¨ï¼ˆç«¯å£ã€åºåˆ—å·ã€ACKã€æ ‡å¿—ä½ï¼‰
- **é˜²ç«å¢™ç»•è¿‡ï¼š** ç®€å•çš„é˜²ç«å¢™åªæ£€æŸ¥åŒ…å¤´ï¼Œä¼šè®¤ä¸ºè¿™æ˜¯ TCP æµé‡
- **æ€§èƒ½ä¼˜åŠ¿ï¼š** æ— å¤´éƒ¨é˜»å¡ã€æ— é‡ä¼ å»¶è¿Ÿã€é€‚åˆå®æ—¶åº”ç”¨

### ä¸å‚è€ƒé¡¹ç›®å¯¹æ¯”

| ç‰¹æ€§ | æœ¬é¡¹ç›® | udp2raw | tinyfecVPN |
|------|-------|---------|------------|
| ä¼ è¾“åè®® | UDP | UDP | UDP |
| TCP ä¼ªè£… | âœ… ç®€å• | âœ… å®Œæ•´ (raw socket) | âŒ æ—  |
| å†…ç½®åŠ å¯† | âœ… AES-256-GCM | âŒ æ—  | âŒ æ—  |
| FEC çº é”™ | âœ… XOR | âŒ æ—  | âœ… Reed-Solomon |
| TUN/TAP | âœ… | âŒ | âœ… |
| P2P ç›´è¿ | âœ… | âŒ | âŒ |
| è¯­è¨€ | Go | C++ | C++ |
| å¤æ‚åº¦ | ä½ | ä¸­ | ä¸­ |

## æ¶æ„å›¾

```
                    æœåŠ¡ç«¯ (10.0.0.1)
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
   å®¢æˆ·ç«¯ 1           å®¢æˆ·ç«¯ 2           å®¢æˆ·ç«¯ 3
  (10.0.0.2)        (10.0.0.3)        (10.0.0.4)
        â”‚                 â”‚                 â”‚
        â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
              P2P ç›´è¿ï¼ˆå¯é€‰ï¼‰

         AES-256-GCM åŠ å¯†ï¼ˆ-k å‚æ•°ï¼‰
              â†“
        FEC çº é”™ + TCP ä¼ªè£…
              â†“
         TUN è™šæ‹Ÿç½‘å¡
```

## é™åˆ¶è¯´æ˜

- ç›®å‰ä»…æ”¯æŒ IPv4
- éœ€è¦ root æƒé™åˆ›å»º TUN è®¾å¤‡
- ä»…æ”¯æŒ Linux ç³»ç»Ÿ
- P2P æµé‡ä¸ä½¿ç”¨ TCP ä¼ªè£…ï¼ˆä½¿ç”¨çº¯ UDPï¼‰ï¼Œä½†ä»ç„¶åŠ å¯†
- P2P éœ€è¦ UDP ç«¯å£æ”¯æŒï¼ˆå¯èƒ½è¢«é˜²ç«å¢™é˜»æ­¢ï¼‰
- TCP ä¼ªè£…å¯èƒ½è¢«æ·±åº¦åŒ…æ£€æµ‹ï¼ˆDPIï¼‰è¯†ç ´

## å¤šéš§é“åœºæ™¯ä¸ TUN è®¾å¤‡

- ç•™ç©º `-tun` æˆ–é…ç½®ä¸­çš„ `tun_name` æ—¶ï¼Œå†…æ ¸ä¼šè‡ªåŠ¨åˆ†é… `tun0`ã€`tun1`ã€`tun2`â€¦â€¦å¯åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹/æœåŠ¡ã€‚
- å¦‚æœéœ€è¦å›ºå®šåç§°ï¼Œç»™æ¯æ¡éš§é“è®¾ç½®ä¸åŒçš„ `tun_name`ï¼ˆä¾‹å¦‚ `tun-b`ã€`tun-c`ã€`tun-d`ï¼‰ï¼Œé¿å…ä¸å…¶ä»–è¿›ç¨‹å†²çªã€‚
- é…åˆ `-service-name` è¿è¡Œå¤šä¸ª systemd æœåŠ¡å³å¯å®ç°å¤šéš§é“è‡ªå¯åŠ¨ï¼Œä¾‹å¦‚ï¼š
  - `sudo ./lightweight-tunnel -service install -service-name tunnel-b -c /etc/lightweight-tunnel/b.json`
  - `sudo ./lightweight-tunnel -service install -service-name tunnel-c -c /etc/lightweight-tunnel/c.json`
  - `sudo ./lightweight-tunnel -service install -service-name tunnel-d -c /etc/lightweight-tunnel/d.json`
  æ¯ä¸ªé…ç½®ä¸­å¯è®¾ç½®ä¸åŒçš„è¿œç«¯ IP/ç«¯å£ï¼ˆå¦‚ 19000/29000/39000ï¼‰å’Œç½‘æ®µï¼ˆ10.0.0.1/24ã€10.0.1.1/24ã€10.0.2.1/24ï¼‰ï¼Œå¯¹åº”çš„ TUN è®¾å¤‡ä¼šåˆ†åˆ«åˆ›å»ºã€‚

## ä¸ºä»€ä¹ˆä¸ç”¨çœŸæ­£çš„ TCPï¼Ÿ

ä½¿ç”¨çœŸæ­£çš„ TCP ä¼šå¯¼è‡´ **TCP-over-TCP é—®é¢˜**ï¼š

- å†…å±‚ TCPï¼ˆåº”ç”¨æµé‡ï¼‰å’Œå¤–å±‚ TCPï¼ˆéš§é“ï¼‰éƒ½ä¼šé‡ä¼ ä¸¢å¤±çš„åŒ…
- åŒé‡é‡ä¼ å¯¼è‡´æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼ˆå¯é™ä½åˆ°åŸæ¥çš„ 1/10ï¼‰
- å»¶è¿Ÿå¢åŠ ï¼Œååé‡å‡å°‘
- ä¸é€‚åˆå®æ—¶åº”ç”¨ï¼ˆæ¸¸æˆã€VoIP ç­‰ï¼‰

ä½¿ç”¨ **UDP + ä¼ªè£… TCP å¤´**çš„ä¼˜åŠ¿ï¼š

- âœ… ç»•è¿‡ç®€å•çš„é˜²ç«å¢™ï¼ˆåªæ£€æŸ¥ç«¯å£å’Œåè®®ï¼‰
- âœ… é¿å… TCP-over-TCP æ€§èƒ½é—®é¢˜
- âœ… æ— å¤´éƒ¨é˜»å¡ï¼Œé€‚åˆå®æ—¶åº”ç”¨
- âœ… FEC çº é”™å¯ä»¥æ¢å¤ä¸¢åŒ…ï¼Œæ— éœ€é‡ä¼ 
- âŒ å¯èƒ½è¢«æ·±åº¦åŒ…æ£€æµ‹ï¼ˆDPIï¼‰è¯†ç ´

## å®‰å…¨å»ºè®®

### æ¨èé…ç½®

1. **å§‹ç»ˆä½¿ç”¨ `-k` å‚æ•°å¯ç”¨åŠ å¯†**
   ```bash
   # ä½¿ç”¨å¼ºå¯†é’¥
   sudo ./lightweight-tunnel -m server -k "complex-random-key-123!" ...
   ```

2. **ä½¿ç”¨å¼ºå¯†é’¥**
   - å¯†é’¥é•¿åº¦å»ºè®® 16 å­—ç¬¦ä»¥ä¸Š
   - åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
   - é¿å…ä½¿ç”¨å¸¸è§è¯æ±‡æˆ–ç®€å•å¯†ç 

3. **å®šæœŸæ›´æ¢å¯†é’¥**
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®å®šæœŸæ›´æ¢åŠ å¯†å¯†é’¥
   - æ›´æ¢å¯†é’¥éœ€è¦åŒæ—¶æ›´æ–°æœåŠ¡ç«¯å’Œæ‰€æœ‰å®¢æˆ·ç«¯

æ›´å¤šå®‰å…¨ä¿¡æ¯è¯·å‚é˜… [SECURITY.md](SECURITY.md)ï¼ŒåŒ…æ‹¬ï¼š
- è¿è¥å•†å¯è§æ€§å’Œæ·±åº¦åŒ…æ£€æµ‹ï¼ˆDPIï¼‰
- GFW å’Œç½‘ç»œç›‘æ§è€ƒé‡
- å¨èƒæ¨¡å‹å’Œæœ€ä½³å®è·µ

## å‚è€ƒé¡¹ç›®

- [udp2raw](https://github.com/wangyu-/udp2raw) - UDP åˆ° TCP è½¬æ¢å·¥å…·
- [tinyfecvpn](https://github.com/wangyu-/tinyfecVPN) - å¸¦ FEC çš„ VPN

## å¼€æºåè®®

MIT License

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Pull Request å’Œ Issueï¼
