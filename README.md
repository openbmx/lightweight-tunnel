# Lightweight Tunnel - è½»é‡çº§éš§é“

<div align="center">

**ä¸“ä¸šçš„å†…ç½‘ç©¿é€ä¸è™šæ‹Ÿç»„ç½‘å·¥å…· Â· çœŸæ­£çš„ TCP ä¼ªè£… Â· é«˜æ€§èƒ½ä½å»¶è¿Ÿ**

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Go Version](https://img.shields.io/badge/Go-1.19+-blue.svg)](https://golang.org)
[![Platform](https://img.shields.io/badge/Platform-Linux-green.svg)](https://www.linux.org/)

[å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹) â€¢ [æ ¸å¿ƒç‰¹æ€§](#-æ ¸å¿ƒç‰¹æ€§) â€¢ [ä½¿ç”¨æŒ‡å—](#-ä½¿ç”¨æŒ‡å—) â€¢ [å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜) â€¢ [æŠ€æœ¯æ¶æ„](#-æŠ€æœ¯æ¶æ„)

</div>

---

## ğŸ“– é¡¹ç›®ç®€ä»‹

Lightweight Tunnel æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å¼€å‘çš„ä¸“ä¸šå†…ç½‘ç©¿é€å’Œè™šæ‹Ÿç»„ç½‘å·¥å…·ã€‚é¡¹ç›®çš„æ ¸å¿ƒä¼˜åŠ¿æ˜¯**çœŸæ­£çš„ TCP ä¼ªè£…èƒ½åŠ›**â€”â€”é€šè¿‡ Raw Socket æŠ€æœ¯åœ¨ç½‘ç»œå±‚æ„é€ å®Œæ•´çš„ TCP/IP æ•°æ®åŒ…ï¼Œåœ¨ä¿æŒé«˜æ€§èƒ½çš„åŒæ—¶ï¼Œæœ‰æ•ˆç»•è¿‡ä¸¥æ ¼çš„é˜²ç«å¢™å’Œæ·±åº¦åŒ…æ£€æµ‹ï¼ˆDPIï¼‰ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| ğŸ”¥ **çœŸå® TCP ä¼ªè£…** | Raw Socket æŠ€æœ¯æ„é€ å®Œæ•´ TCP/IP åŒ…ï¼Œç½‘ç»œå±‚å³ä¸ºçœŸå® TCP åè®® |
| ğŸš€ **é«˜æ€§èƒ½ä¼ è¾“** | é¿å… TCP-over-TCP é—®é¢˜ï¼ŒFEC å‰å‘çº é”™ä¿è¯è´¨é‡ |
| ğŸ” **å†›ç”¨çº§åŠ å¯†** | AES-256-GCM ç«¯åˆ°ç«¯åŠ å¯†ï¼Œä¿æŠ¤æ‰€æœ‰éš§é“æµé‡ |
| ğŸŒ **æ™ºèƒ½ P2P** | NAT ç©¿é€æŠ€æœ¯å®ç°å®¢æˆ·ç«¯ç›´è¿ï¼Œé™ä½å»¶è¿Ÿ |
| ğŸ› ï¸ **è‡ªé€‚åº”ç½‘ç»œ** | è‡ªåŠ¨ MTU æ£€æµ‹ï¼Œæ™ºèƒ½è¯†åˆ«ç½‘ç»œç±»å‹ä¼˜åŒ–å‚æ•° |
| ğŸ”„ **è‡ªåŠ¨é‡è¿** | æ–­çº¿è‡ªåŠ¨é‡è¿ï¼ŒæŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œæ— éœ€äººå·¥å¹²é¢„ |
| ğŸ“¦ **ç®€å•æ˜“ç”¨** | æç®€é…ç½®ï¼Œæ”¯æŒå‘½ä»¤è¡Œå’Œé…ç½®æ–‡ä»¶ä¸¤ç§æ–¹å¼ |

### ğŸ’¼ é€‚ç”¨åœºæ™¯

| åœºæ™¯ | æè¿° |
|-----|------|
| ğŸ¢ ä¼ä¸šå†…ç½‘äº’è” | å¤šåˆ†æ”¯æœºæ„é—´å»ºç«‹å®‰å…¨è™šæ‹Ÿå±€åŸŸç½‘ |
| ğŸ  å®¶åº­æœåŠ¡å™¨ | ä»å¤–ç½‘å®‰å…¨è®¿é—® NASã€æœåŠ¡å™¨ç­‰è®¾å¤‡ |
| ğŸ® æ¸¸æˆè”æœº | ä¸ºå±€åŸŸç½‘æ¸¸æˆå»ºç«‹ä½å»¶è¿Ÿè™šæ‹Ÿç½‘ç»œ |
| ğŸ”§ å¼€å‘æµ‹è¯• | å¿«é€Ÿå»ºç«‹è·¨ç½‘ç»œçš„å¼€å‘æµ‹è¯•ç¯å¢ƒ |
| ğŸŒ å¤šç‚¹äº’è” | Mesh ç½‘ç»œï¼Œä»»æ„èŠ‚ç‚¹é—´ç›´æ¥é€šä¿¡ |
| ğŸ”¥ çªç ´å°é” | çœŸæ­£ TCP ä¼ªè£…ï¼Œç»•è¿‡é˜²ç«å¢™å’Œ DPI |

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1ï¸âƒ£ çœŸå® TCP ä¼ªè£…ï¼ˆRaw Socket æ¨¡å¼ï¼‰

**æœ¬é¡¹ç›®çš„æ ¸å¿ƒä¼˜åŠ¿**ï¼šä¸åŒäºç®€å•çš„"UDP åŠ å‡ TCP å¤´"ï¼Œæˆ‘ä»¬å®ç°äº†çœŸæ­£çš„ TCP åè®®ä¼ªè£…ã€‚

#### æŠ€æœ¯å®ç°åŸç†

```
âŒ ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆå®¹æ˜“è¢«è¯†åˆ«ï¼‰
UDP åŒ… â†’ [UDP Header (åè®®å·=17) + ä¼ªé€  TCP å¤´ + æ•°æ®]
         â†“
      é˜²ç«å¢™æ£€æµ‹åˆ° UDP åè®®ï¼Œå®¹æ˜“è¢«è¯†åˆ«å’Œæ‹¦æˆª

âœ… æœ¬é¡¹ç›®ï¼ˆå®Œç¾ä¼ªè£…ï¼‰
Raw Socket â†’ [IP Header (åè®®å·=6) + çœŸå® TCP Header + æ•°æ®]
             â†“
          ç½‘ç»œå±‚å°±æ˜¯æ ‡å‡† TCP æµé‡ï¼Œæ— æ³•åŒºåˆ†çœŸä¼ª
```

#### æŠ€æœ¯ç‰¹æ€§

- âœ… ä½¿ç”¨ Raw Socket æ„é€ å®Œæ•´ IP/TCP æ•°æ®åŒ…
- âœ… çœŸå®çš„ TCP ä¸‰æ¬¡æ¡æ‰‹ï¼ˆSYNã€SYN-ACKã€ACKï¼‰
- âœ… ç»´æŠ¤çœŸå®çš„ TCP åºåˆ—å·å’Œç¡®è®¤å·
- âœ… åŒ…å«å®Œæ•´çš„ TCP é€‰é¡¹ï¼ˆMSSã€SACKã€Window Scaleã€Timestampï¼‰
- âœ… æ­£ç¡®è®¡ç®— TCP å’Œ IP æ ¡éªŒå’Œ
- âœ… è‡ªåŠ¨ç®¡ç† iptables è§„åˆ™ï¼Œé˜»æ­¢å†…æ ¸å‘é€ RST åŒ…
- âœ… **å¯å®Œç¾ç»•è¿‡ TCP-only é˜²ç«å¢™å’Œ DPI æ£€æµ‹**

> âš ï¸ **æ³¨æ„**ï¼šRaw Socket æ¨¡å¼éœ€è¦ root æƒé™è¿è¡Œã€‚

### 2ï¸âƒ£ é«˜æ€§èƒ½æ¶æ„

#### é¿å… TCP-over-TCP ç¾éš¾

åœ¨éš§é“æŠ€æœ¯ä¸­ï¼ŒTCP-over-TCP æ˜¯ä¸€ä¸ªç»å…¸çš„æ€§èƒ½æ€æ‰‹ï¼š

```
é—®é¢˜åœºæ™¯ï¼š
åº”ç”¨ TCP â†’ éš§é“ TCP â†’ ç½‘ç»œ
   â†“         â†“
 é‡ä¼ æœºåˆ¶   é‡ä¼ æœºåˆ¶    â†’ åŒé‡é‡ä¼ å¯¼è‡´æ€§èƒ½å´©æºƒ
 æ‹¥å¡æ§åˆ¶   æ‹¥å¡æ§åˆ¶    â†’ æ‹¥å¡æ§åˆ¶ç›¸äº’å¹²æ‰°

æœ¬é¡¹ç›®æ–¹æ¡ˆï¼š
åº”ç”¨æµé‡ â†’ FEC çº é”™ â†’ Raw TCP ä¼ªè£… â†’ ç½‘ç»œ
           â†“
        ä¸»åŠ¨çº é”™ï¼Œæ— é‡ä¼ å¼€é”€ï¼Œå»¶è¿Ÿä½ä¸”ç¨³å®š
```

#### æ€§èƒ½ä¼˜åŠ¿

- âš¡ **ä½å»¶è¿Ÿ**ï¼šé¿å…åŒé‡é‡ä¼ ï¼Œå»¶è¿Ÿæ›´ç¨³å®š
- ğŸš„ **é«˜åå**ï¼šFEC ä¸»åŠ¨çº é”™ï¼Œæ— éœ€ç­‰å¾…é‡ä¼ 
- ğŸ¯ **é€‚åˆå®æ—¶åº”ç”¨**ï¼šæ¸¸æˆã€VoIPã€è§†é¢‘ä¼šè®®è¡¨ç°ä¼˜ç§€
- ğŸ“Š **æ™ºèƒ½é˜Ÿåˆ—**ï¼šé»˜è®¤ 5000 å¤§å°çš„å‘é€/æ¥æ”¶é˜Ÿåˆ—

### 3ï¸âƒ£ FEC å‰å‘çº é”™

åœ¨å¼±ç½‘ç¯å¢ƒä¸‹ä¿è¯ä¼ è¾“è´¨é‡çš„å…³é”®æŠ€æœ¯ï¼š

```
ç¼–ç åŸç†ï¼š
åŸå§‹æ•°æ® [D1][D2][D3][D4][D5][D6][D7][D8][D9][D10]
  â†“ Reed-Solomon ç¼–ç 
å‘é€åŒ…  [D1][D2][D3]...[D10][P1][P2][P3]

æ¥æ”¶åœºæ™¯ï¼š
æ”¶åˆ°åŒ…  [D1][ Ã—][D3][D4][D5][D6][ Ã—][D8][D9][D10][P1][P2][P3]
  â†“ ä¸¢å¤± 2 ä¸ªï¼Œä»å¯æ¢å¤
å®Œæ•´æ•°æ® [D1][D2][D3][D4][D5][D6][D7][D8][D9][D10] âœ“
```

**å‚æ•°é…ç½®å»ºè®®**ï¼š

| ç½‘ç»œç¯å¢ƒ | fec_data | fec_parity | å¯æ¢å¤ä¸¢åŒ…ç‡ | å¸¦å®½å¼€é”€ |
|---------|----------|------------|-------------|---------|
| ä½ä¸¢åŒ… (<1%) | 20 | 2 | 9% | 10% |
| æ ‡å‡† (1-3%) | 10 | 3 | 23% | 30% |
| é«˜ä¸¢åŒ… (3-10%) | 10 | 5 | 33% | 50% |
| æç«¯ (>10%) | 8 | 6 | 43% | 75% |

### 4ï¸âƒ£ æ™ºèƒ½ P2P ç›´è¿

#### è¿æ¥å»ºç«‹æµç¨‹

```
æ­¥éª¤1ï¼šå®¢æˆ·ç«¯æ³¨å†Œ      A â†’ [Server] â† B
æ­¥éª¤2ï¼šäº¤æ¢åœ°å€ä¿¡æ¯    A â† [Server] â†’ B (è·å–å¯¹æ–¹å…¬ç½‘ IP:Port)
æ­¥éª¤3ï¼šåŒæ—¶æ‰“æ´       A â”€â”€UDPæ‰“æ´åŒ…â”€â”€â†’ B
æ­¥éª¤4ï¼šP2P å»ºç«‹       A â†â”€â”€â”€â”€ç›´è¿â”€â”€â”€â”€â†’ B (åç»­ä¸ç»æœåŠ¡å™¨)
```

#### è·¯ç”±ä¼˜å…ˆçº§ç­–ç•¥

1. ğŸ¥‡ **æœ¬åœ°ç½‘ç»œ** - åŒä¸€å±€åŸŸç½‘ï¼Œç›´æ¥ä½¿ç”¨å†…ç½‘ IP
2. ğŸ¥ˆ **P2P ç›´è¿** - é€šè¿‡ NAT æ‰“æ´çš„å…¬ç½‘ç‚¹å¯¹ç‚¹è¿æ¥
3. ğŸ¥‰ **æœåŠ¡å™¨ä¸­è½¬** - P2P å¤±è´¥æ—¶è‡ªåŠ¨å›é€€

#### NAT å…¼å®¹æ€§

| NAT ç±»å‹ | P2P æˆåŠŸç‡ | è¯´æ˜ |
|---------|-----------|------|
| å®Œå…¨é”¥å½¢ (Full Cone) | âœ… 99% | æœ€ç†æƒ³ï¼Œä»»ä½•å¤–éƒ¨ä¸»æœºå¯è¿æ¥ |
| é™åˆ¶é”¥å½¢ (Restricted) | âœ… 95% | åªæœ‰é€šä¿¡è¿‡çš„ IP å¯è¿æ¥ |
| ç«¯å£é™åˆ¶ (Port Restricted) | âœ… 90% | åªæœ‰é€šä¿¡è¿‡çš„ IP:Port å¯è¿æ¥ |
| å¯¹ç§°å‹ (Symmetric) | âœ… 70-80% | ä½¿ç”¨ç«¯å£é¢„æµ‹ï¼ŒæˆåŠŸç‡æ˜¾è‘—æå‡ |

**P2PæŠ€æœ¯ç‰¹ç‚¹**ï¼ˆä½¿ç”¨UDPæ‰“æ´ï¼Œä¸æ˜¯TCPæ‰“æ´ï¼‰ï¼š
- ğŸ”§ **UDPæ‰“æ´åŸç†**: P2Pè¿æ¥ä½¿ç”¨UDPåè®®è¿›è¡ŒNATç©¿é€ï¼Œè€ŒéTCPæ‰“æ´
- âœ… **ä¸ºä»€ä¹ˆç”¨UDP**: TCPæ‰“æ´æˆåŠŸç‡æä½(<5%)ï¼ŒUDPæ‰“æ´æˆåŠŸç‡é«˜(60-95%)
- âœ¨ æ›´å¿«æ¡æ‰‹é€Ÿåº¦ï¼ˆ50ms é—´éš”ï¼Œ30 æ¬¡å°è¯•ï¼‰
- âœ¨ è‡ªé€‚åº”ä¿æ´»ï¼ˆå»ºç«‹æ—¶ 3 ç§’ï¼Œç¨³å®šå 10 ç§’ï¼‰
- âœ¨ æ™ºèƒ½ç«¯å£é¢„æµ‹ï¼ˆè¦†ç›– Â±50 ç«¯å£èŒƒå›´ï¼Œä¼˜å…ˆé¡ºåºåˆ†é…ï¼‰
- âœ¨ å¯¹ç§° NAT æˆåŠŸç‡ä» 50-60% æå‡è‡³ 70-80%
- ğŸ”„ P2På¤±è´¥è‡ªåŠ¨å›é€€åˆ°æœåŠ¡å™¨ä¸­è½¬
- ğŸ”„ P2På¤±è´¥è‡ªåŠ¨å›é€€åˆ°æœåŠ¡å™¨ä¸­è½¬

### 5ï¸âƒ£ å®‰å…¨åŠ å¯†

| é¡¹ç›® | å®ç° |
|-----|------|
| åŠ å¯†ç®—æ³• | AES-256-GCM (Galois/Counter Mode) |
| å¯†é’¥æ´¾ç”Ÿ | SHA-256 å“ˆå¸Œç”¨æˆ·å¯†é’¥ |
| Nonce | æ¯ä¸ªæ•°æ®åŒ…ä½¿ç”¨ç‹¬ç«‹éšæœº nonce |
| è®¤è¯æ ‡ç­¾ | 16 å­—èŠ‚æ ‡ç­¾ç¡®ä¿å®Œæ•´æ€§å’ŒçœŸå®æ€§ |
| è¦†ç›–èŒƒå›´ | æ‰€æœ‰æµé‡ï¼ˆåŒ…æ‹¬ P2Pï¼‰ç«¯åˆ°ç«¯åŠ å¯† |
| å¯†é’¥è½®æ¢ | æœåŠ¡ç«¯æ”¯æŒå®šæœŸè‡ªåŠ¨è½®æ¢ |

### 6ï¸âƒ£ è‡ªåŠ¨é‡è¿æœºåˆ¶

å®¢æˆ·ç«¯å†…ç½®æ™ºèƒ½é‡è¿ï¼Œç¡®ä¿è¿æ¥ç¨³å®šæ€§ï¼š

- âœ… **è‡ªåŠ¨æ£€æµ‹**ï¼šå®æ—¶ç›‘æµ‹è¿æ¥çŠ¶æ€
- âœ… **æŒ‡æ•°é€€é¿**ï¼š1s â†’ 2s â†’ 4s â†’ 8s â†’ 16s â†’ 32sï¼ˆæœ€å¤§ï¼‰
- âœ… **æ— é™é‡è¯•**ï¼šæŒç»­å°è¯•ç›´åˆ°æˆåŠŸ
- âœ… **é€æ˜æ¢å¤**ï¼šé‡è¿åç«‹å³æ¢å¤ï¼Œåº”ç”¨å±‚æ— æ„ŸçŸ¥

**é€‚ç”¨åœºæ™¯**ï¼šæœåŠ¡å™¨ç»´æŠ¤ã€ç½‘ç»œæ³¢åŠ¨ã€é˜²ç«å¢™è°ƒæ•´ã€ç§»åŠ¨ç½‘ç»œåˆ‡æ¢

### 7ï¸âƒ£ è‡ªé€‚åº” MTU æ£€æµ‹

è®¾ç½® `mtu: 0` å¯ç”¨è‡ªåŠ¨æ£€æµ‹ï¼š

| ç½‘ç»œç±»å‹ | æ¨è MTU | è¯´æ˜ |
|---------|---------|------|
| ä»¥å¤ªç½‘ | 1371 | æ ‡å‡†ä»¥å¤ªç½‘ |
| PPPoE | 1343 | DSL å®½å¸¦è¿æ¥ |
| ç§»åŠ¨ç½‘ç»œ | 1200 | ä¿å®ˆé…ç½®ï¼Œé€‚åº”æ€§å¼º |
| WiFi | 1371 | é€šå¸¸ä¸ä»¥å¤ªç½‘ç›¸åŒ |
| VPN | 1300 | è€ƒè™‘ VPN é¢å¤–å¼€é”€ |

**æ£€æµ‹æµç¨‹**ï¼š
1. è¯†åˆ«ç½‘ç»œç±»å‹ï¼ˆEthernetã€PPPoEã€WiFiã€ç§»åŠ¨ç­‰ï¼‰
2. é€‰æ‹©æ¨è MTU å€¼
3. å®¢æˆ·ç«¯æ¨¡å¼è¿›è¡Œå®é™…è·¯å¾„ MTU æµ‹è¯•
4. è‡ªåŠ¨è°ƒæ•´è€ƒè™‘åŠ å¯†å’Œåè®®å¼€é”€

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç³»ç»Ÿè¦æ±‚

| é¡¹ç›® | è¦æ±‚ |
|-----|------|
| æ“ä½œç³»ç»Ÿ | Linux (å†…æ ¸ 2.6+) |
| æƒé™ | Rootï¼ˆRaw Socket å’Œ TUN è®¾å¤‡å¿…éœ€ï¼‰ |
| å†…å­˜ | æœ€ä½ 64MBï¼Œæ¨è 128MB+ |
| ç½‘ç»œ | è‡³å°‘ä¸€å°è®¾å¤‡éœ€è¦å…¬ç½‘ IP æˆ–ç«¯å£è½¬å‘ |
| Go ç‰ˆæœ¬ | Go 1.19+ï¼ˆä»…ç¼–è¯‘æ—¶éœ€è¦ï¼‰ |

### å®‰è£…æ–¹æ³•

#### æ–¹æ³• 1ï¼šä»æºç ç¼–è¯‘ï¼ˆæ¨èï¼‰

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/openbmx/lightweight-tunnel.git
cd lightweight-tunnel

# ç¼–è¯‘ï¼ˆä¼šè‡ªåŠ¨ä¸‹è½½ä¾èµ–ï¼‰
go build -o lightweight-tunnel ./cmd/lightweight-tunnel

# å¯é€‰ï¼šå®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„
sudo cp lightweight-tunnel /usr/local/bin/

# éªŒè¯
./lightweight-tunnel -v
```

#### æ–¹æ³• 2ï¼šä½¿ç”¨ Makefile

```bash
make build          # ç¼–è¯‘ï¼ˆäºŒè¿›åˆ¶åœ¨ bin/lightweight-tunnelï¼‰
make install        # å®‰è£…ä¾èµ–
make test           # è¿è¡Œæµ‹è¯•
```

#### æ–¹æ³• 3ï¼šæ³¨å†Œä¸ºç³»ç»ŸæœåŠ¡

```bash
# ç¼–è¯‘
make build

# å®‰è£… systemd æœåŠ¡
sudo make install-service \
  CONFIG_PATH=/etc/lightweight-tunnel/config-server.json \
  SERVICE_NAME=lightweight-tunnel-server

# é…ç½®æ–‡ä»¶æƒé™ï¼ˆç¤ºä¾‹ï¼‰
sudo mkdir -p /etc/lightweight-tunnel
sudo chown root:root /etc/lightweight-tunnel/*.json
sudo chmod 600 /etc/lightweight-tunnel/*.json  # ä»… root å¯è¯»å†™

# å¯åŠ¨æœåŠ¡
sudo systemctl start lightweight-tunnel-server
sudo systemctl status lightweight-tunnel-server

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u lightweight-tunnel-server -f
```

**æœåŠ¡ç‰¹æ€§**ï¼š
- âœ… ä»¥ä¸“ç”¨ç³»ç»Ÿç”¨æˆ·è¿è¡Œ
- âœ… ä»…æˆäºˆå¿…è¦æƒé™ï¼ˆCAP_NET_ADMINã€CAP_NET_RAWï¼‰
- âœ… å®‰å…¨éš”ç¦»ï¼ˆPrivateTmpã€ProtectHome ç­‰ï¼‰
- âœ… è‡ªåŠ¨é‡å¯
- âœ… å¼€æœºè‡ªå¯

#### æ–¹æ³• 4ï¼šä¸€é”®æ›´æ–°

```bash
# åœ¨ä»“åº“æ ¹ç›®å½•æ‰§è¡Œ
./mupdate

# è‡ªåŠ¨å®Œæˆï¼š
# 1. git pull æ‹‰å–æœ€æ–°ä»£ç 
# 2. make build ç¼–è¯‘
# 3. æ›¿æ¢ /usr/local/bin/lightweight-tunnel

# å¦‚æœæœåŠ¡æ­£åœ¨è¿è¡Œï¼Œéœ€æ‰‹åŠ¨é‡å¯
sudo systemctl restart lightweight-tunnel-server
```

### å¿«é€Ÿæµ‹è¯•

#### åœºæ™¯ 1ï¼šæœ€ç®€å•çš„ç‚¹å¯¹ç‚¹è¿æ¥

**æœåŠ¡ç«¯**ï¼ˆå…¬ç½‘ IP ä¸»æœºï¼‰ï¼š
```bash
sudo ./lightweight-tunnel \
  -m server \
  -l 0.0.0.0:9000 \
  -t 10.0.0.1/24 \
  -k "my-secret-key-2024"
```

**å®¢æˆ·ç«¯**ï¼š
```bash
sudo ./lightweight-tunnel \
  -m client \
  -r <æœåŠ¡å™¨IP>:9000 \
  -t 10.0.0.2/24 \
  -k "my-secret-key-2024"
```

**éªŒè¯è¿æ¥**ï¼š
```bash
# åœ¨å®¢æˆ·ç«¯
ping 10.0.0.1    # ping æœåŠ¡å™¨

# åœ¨æœåŠ¡ç«¯
ping 10.0.0.2    # ping å®¢æˆ·ç«¯
```

#### åœºæ™¯ 2ï¼šå¤šå®¢æˆ·ç«¯ç»„ç½‘

**æœåŠ¡ç«¯**ï¼š
```bash
sudo ./lightweight-tunnel \
  -m server \
  -l 0.0.0.0:9000 \
  -t 10.0.0.1/24 \
  -k "company-key" \
  -multi-client \
  -max-clients 100
```

**å®¢æˆ·ç«¯ A**ï¼š
```bash
sudo ./lightweight-tunnel \
  -m client \
  -r <æœåŠ¡å™¨IP>:9000 \
  -t 10.0.0.10/24 \
  -k "company-key"
```

**å®¢æˆ·ç«¯ B**ï¼š
```bash
sudo ./lightweight-tunnel \
  -m client \
  -r <æœåŠ¡å™¨IP>:9000 \
  -t 10.0.0.20/24 \
  -k "company-key"
```

ç°åœ¨å®¢æˆ·ç«¯ A å’Œ B å¯ä»¥ç›´æ¥é€šä¿¡ï¼š
```bash
# åœ¨å®¢æˆ·ç«¯ A
ping 10.0.0.20
ssh user@10.0.0.20
```

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### é…ç½®æ–‡ä»¶ä½¿ç”¨

#### ç”Ÿæˆé…ç½®æ¨¡æ¿

```bash
./lightweight-tunnel -g config.json
```

ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š
- `config.json` - æœåŠ¡ç«¯é…ç½®
- `config.json.client` - å®¢æˆ·ç«¯é…ç½®

#### æœåŠ¡ç«¯é…ç½®ç¤ºä¾‹

```json
{
  "mode": "server",
  "local_addr": "0.0.0.0:9000",
  "tunnel_addr": "10.0.0.1/24",
  "key": "è¯·ä¿®æ”¹ä¸ºæ‚¨çš„å¼ºå¯†é’¥",
  "mtu": 0,
  "tun_name": "tun0",
  "routes": ["10.10.0.0/16", "10.20.0.0/16"],
  "config_push_interval": 600,
  "multi_client": true,
  "max_clients": 100,
  "client_isolation": false,
  "enable_nat_detection": true,
  "enable_xdp": true,
  "enable_kernel_tune": true
}
```

#### å®¢æˆ·ç«¯é…ç½®ç¤ºä¾‹

```json
{
  "mode": "client",
  "remote_addr": "æœåŠ¡å™¨IP:9000",
  "tunnel_addr": "10.0.0.2/24",
  "key": "è¯·ä¿®æ”¹ä¸ºæ‚¨çš„å¼ºå¯†é’¥",
  "mtu": 0,
  "tun_name": "tun1",
  "routes": ["192.168.1.0/24"],
  "p2p_enabled": true,
  "p2p_port": 19000,
  "enable_nat_detection": true,
  "enable_xdp": true,
  "enable_kernel_tune": true
}
```

#### ä½¿ç”¨é…ç½®æ–‡ä»¶

```bash
# æœåŠ¡ç«¯
sudo ./lightweight-tunnel -c config-server.json

# å®¢æˆ·ç«¯
sudo ./lightweight-tunnel -c config-client.json
```

### é…ç½®å‚æ•°è¯´æ˜

#### åŸºç¡€å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|--------|
| `mode` | è¿è¡Œæ¨¡å¼ï¼šserver æˆ– client | å¿…å¡« |
| `local_addr` | æœåŠ¡ç«¯ç›‘å¬åœ°å€ | 0.0.0.0:9000 |
| `remote_addr` | å®¢æˆ·ç«¯è¿æ¥çš„æœåŠ¡å™¨åœ°å€ | å¿…å¡«ï¼ˆclientï¼‰ |
| `tunnel_addr` | è™šæ‹Ÿç½‘ç»œ IPï¼ˆCIDR æ ¼å¼ï¼‰ | å¿…å¡« |
| `key` | åŠ å¯†å¯†é’¥ï¼ˆåŒæ–¹å¿…é¡»ä¸€è‡´ï¼‰ | ç©ºï¼ˆä¸åŠ å¯†ï¼‰ |
| `mtu` | æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆ0=è‡ªåŠ¨ï¼‰ | 1400 |
| `tun_name` | TUN è®¾å¤‡åï¼ˆç©º=è‡ªåŠ¨ï¼‰ | è‡ªåŠ¨ |

#### FEC å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|--------|
| `fec_data` / `FECDataShards` | æ•°æ®åˆ†ç‰‡æ•° | 10 |
| `fec_parity` / `FECParityShards` | æ ¡éªŒåˆ†ç‰‡æ•° | 3 |

**å·¥ä½œåŸç†**ï¼šæ€»åˆ†ç‰‡ = data + parityï¼Œå¯æ¢å¤æœ€å¤š parity ä¸ªä¸¢å¤±åˆ†ç‰‡ã€‚ä¾‹å¦‚ï¼š10 data + 3 parity = 13 ä¸ªåˆ†ç‰‡ï¼Œå¯æ¢å¤ 23% ä¸¢åŒ…ç‡ã€‚

#### é˜Ÿåˆ—å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|--------|
| `send_queue` / `SendQueueSize` | å‘é€é˜Ÿåˆ—å¤§å° | 5000 |
| `recv_queue` / `RecvQueueSize` | æ¥æ”¶é˜Ÿåˆ—å¤§å° | 5000 |

#### è·¯ç”±å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|--------|
| `routes` | å®£å‘Šç»™å¯¹ç«¯çš„ CIDR è·¯ç”±åˆ—è¡¨ | [] |
| `config_push_interval` | æœåŠ¡ç«¯æ¨é€é…ç½®é—´éš”ï¼ˆç§’ï¼Œ0=ç¦ç”¨ï¼‰ | 0 |

#### æœåŠ¡ç«¯ä¸“ç”¨å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|--------|
| `multi_client` | å¯ç”¨å¤šå®¢æˆ·ç«¯æ”¯æŒ | true |
| `max_clients` | æœ€å¤§å®¢æˆ·ç«¯æ•° | 100 |
| `client_isolation` | å®¢æˆ·ç«¯éš”ç¦»ï¼ˆä¸èƒ½äº’é€šï¼‰ | false |

#### P2P å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|--------|
| `p2p_enabled` | å¯ç”¨ P2P ç›´è¿ | true |
| `p2p_port` | P2P UDP ç«¯å£ï¼ˆ0=è‡ªåŠ¨ï¼‰ | 0 |
| `enable_nat_detection` | å¯ç”¨ NAT ç±»å‹æ£€æµ‹ | true |

#### æ€§èƒ½ä¼˜åŒ–å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|--------|
| `enable_xdp` | å¯ç”¨ eBPF/XDP å¿«é€Ÿè·¯å¾„ | true |
| `enable_kernel_tune` | å¯ç”¨å†…æ ¸è°ƒä¼˜ï¼ˆTFO/BBR2ï¼‰ | true |

#### å¤§è§„æ¨¡éƒ¨ç½²å‚æ•°ï¼ˆ50+ å®¢æˆ·ç«¯ï¼‰

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|--------|
| `broadcast_throttle_ms` | å¹¿æ’­æœ€å°é—´éš”ï¼ˆæ¯«ç§’ï¼‰ | 1000 |
| `enable_incremental_update` | ä»…å¹¿æ’­å˜åŒ–ä¿¡æ¯ | true |
| `max_peer_info_batch_size` | æ¯æ‰¹æœ€å¤§èŠ‚ç‚¹æ•° | 10 |
| `route_advert_interval` | è·¯ç”±é€šå‘Šé—´éš”ï¼ˆç§’ï¼‰ | 300 |
| `p2p_keepalive_interval` | P2P ä¿æ´»é—´éš”ï¼ˆç§’ï¼‰ | 25 |

### å‘½ä»¤è¡Œå‚æ•°

**åŸºç¡€å‚æ•°**ï¼š
```
-m string      è¿è¡Œæ¨¡å¼ï¼šserver æˆ– client
-l string      ç›‘å¬åœ°å€ï¼ˆæœåŠ¡ç«¯ï¼Œæ ¼å¼ï¼šIP:ç«¯å£ï¼‰
-r string      æœåŠ¡å™¨åœ°å€ï¼ˆå®¢æˆ·ç«¯ï¼Œæ ¼å¼ï¼šIP:ç«¯å£ï¼‰
-t string      éš§é“ IPï¼ˆæ ¼å¼ï¼šIP/CIDRï¼Œå¦‚ 10.0.0.2/24ï¼‰
-k string      åŠ å¯†å¯†é’¥ï¼ˆå¼ºçƒˆæ¨èï¼ŒåŒæ–¹å¿…é¡»ç›¸åŒï¼‰
```

**å¯é€‰å‚æ•°**ï¼š
```
-mtu int              MTU å¤§å°ï¼ˆ0=è‡ªåŠ¨æ£€æµ‹ï¼Œé»˜è®¤ï¼š1400ï¼‰
-tun-name string      TUN è®¾å¤‡åï¼ˆé»˜è®¤è‡ªåŠ¨ï¼‰
-routes string        CIDR è·¯ç”±åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
-fec-data int         FEC æ•°æ®åˆ†ç‰‡æ•°ï¼ˆé»˜è®¤ï¼š10ï¼‰
-fec-parity int       FEC æ ¡éªŒåˆ†ç‰‡æ•°ï¼ˆé»˜è®¤ï¼š3ï¼‰
-send-queue int       å‘é€é˜Ÿåˆ—å¤§å°ï¼ˆé»˜è®¤ï¼š5000ï¼‰
-recv-queue int       æ¥æ”¶é˜Ÿåˆ—å¤§å°ï¼ˆé»˜è®¤ï¼š5000ï¼‰
-p2p                  å¯ç”¨ P2Pï¼ˆé»˜è®¤ï¼štrueï¼‰
-p2p-port int         P2P ç«¯å£ï¼ˆé»˜è®¤ï¼š0ï¼Œè‡ªåŠ¨ï¼‰
-xdp                  å¯ç”¨ XDPï¼ˆé»˜è®¤ï¼štrueï¼‰
-kernel-tune          å¯ç”¨å†…æ ¸è°ƒä¼˜ï¼ˆé»˜è®¤ï¼štrueï¼‰
-nat-detection        å¯ç”¨ NAT æ£€æµ‹ï¼ˆé»˜è®¤ï¼štrueï¼‰
```

**æœåŠ¡ç«¯ä¸“ç”¨**ï¼š
```
-multi-client         å¯ç”¨å¤šå®¢æˆ·ç«¯ï¼ˆé»˜è®¤ï¼štrueï¼‰
-max-clients int      æœ€å¤§å®¢æˆ·ç«¯æ•°ï¼ˆé»˜è®¤ï¼š100ï¼‰
-client-isolation     å¯ç”¨å®¢æˆ·ç«¯éš”ç¦»ï¼ˆé»˜è®¤ï¼šfalseï¼‰
-config-push-interval int  æ¨é€é…ç½®é—´éš”ç§’æ•°ï¼ˆ0=ç¦ç”¨ï¼‰
```

**å…¶ä»–**ï¼š
```
-c string    ä» JSON æ–‡ä»¶åŠ è½½é…ç½®
-g string    ç”Ÿæˆç¤ºä¾‹é…ç½®æ–‡ä»¶
-v           æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
```

### é«˜çº§åŠŸèƒ½

#### 1. åŠ¨æ€å¯†é’¥è½®æ¢

æœåŠ¡ç«¯å®šæœŸç”Ÿæˆæ–°å¯†é’¥å¹¶è‡ªåŠ¨æ¨é€ç»™æ‰€æœ‰å®¢æˆ·ç«¯ï¼š

```bash
sudo ./lightweight-tunnel \
  -m server \
  -l 0.0.0.0:9000 \
  -t 10.0.0.1/24 \
  -k "initial-key" \
  -config-push-interval 600    # æ¯ 10 åˆ†é’Ÿè½®æ¢
```

**ç‰¹æ€§**ï¼š
- âœ… æœåŠ¡ç«¯è‡ªåŠ¨ç”Ÿæˆéšæœºå¯†é’¥
- âœ… å®¢æˆ·ç«¯è‡ªåŠ¨åˆ‡æ¢å¹¶é‡è¿
- âœ… 15 ç§’å®½é™æœŸåæ—§å¯†é’¥å¤±æ•ˆ
- âœ… æ–°å¯†é’¥è‡ªåŠ¨å†™å›é…ç½®æ–‡ä»¶

#### 2. è·¯ç”±å®£å‘Š

å‘å¯¹ç«¯å®£å‘Šæœ¬åœ°ç½‘æ®µï¼Œè‡ªåŠ¨å»ºç«‹è·¯ç”±ï¼š

```bash
sudo ./lightweight-tunnel \
  -m client \
  -r <æœåŠ¡å™¨IP>:9000 \
  -t 10.0.0.2/24 \
  -k "my-key" \
  -routes "192.168.1.0/24,192.168.2.0/24"
```

æœåŠ¡ç«¯ä¼šè‡ªåŠ¨æ¥æ”¶å¹¶å®‰è£…è·¯ç”±ï¼Œå‘å¾€è¿™äº›ç½‘æ®µçš„æµé‡é€šè¿‡éš§é“è½¬å‘ã€‚

#### 3. æŒ‡å®š TUN è®¾å¤‡

```bash
sudo ./lightweight-tunnel \
  -m server \
  -t 10.0.0.1/24 \
  -tun-name mytun0
```

> ğŸ’¡ å¦‚æœåç§°å†²çªæˆ–éæ³•ï¼Œä¼šå›é€€åˆ°ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ã€‚

---

## âš™ï¸ æ€§èƒ½è°ƒä¼˜

### ç½‘ç»œç¯å¢ƒé€‚é…

#### é«˜é€Ÿå†…ç½‘ç¯å¢ƒ

```bash
sudo ./lightweight-tunnel \
  -m client \
  -r <æœåŠ¡å™¨IP>:9000 \
  -t 10.0.0.2/24 \
  -k "my-key" \
  -mtu 1371 \
  -send-queue 10000 \
  -recv-queue 10000
```

**ä¼˜åŒ–ç‚¹**ï¼šå¤§é˜Ÿåˆ—å¤„ç†çªå‘æµé‡ï¼Œä¿æŒæ ‡å‡† MTU

#### å¼±ç½‘ç¯å¢ƒï¼ˆé«˜ä¸¢åŒ…ï¼‰

```bash
sudo ./lightweight-tunnel \
  -m client \
  -r <æœåŠ¡å™¨IP>:9000 \
  -t 10.0.0.2/24 \
  -k "my-key" \
  -mtu 1200 \
  --fec-data 10 \
  --fec-parity 5
```

**ä¼˜åŒ–ç‚¹**ï¼šå° MTU é™ä½å•åŒ…å½±å“ï¼Œå¢å¼º FEC æé«˜æ¢å¤èƒ½åŠ›

#### ç§»åŠ¨ç½‘ç»œ

```bash
sudo ./lightweight-tunnel \
  -m client \
  -r <æœåŠ¡å™¨IP>:9000 \
  -t 10.0.0.2/24 \
  -k "my-key" \
  -mtu 0    # è‡ªåŠ¨æ£€æµ‹
```

**ä¼˜åŒ–ç‚¹**ï¼šå¯ç”¨è‡ªåŠ¨ MTU æ£€æµ‹é€‚åº”ç½‘ç»œå˜åŒ–

### å¤§è§„æ¨¡éƒ¨ç½²ï¼ˆ50+ å®¢æˆ·ç«¯ï¼‰

é’ˆå¯¹å¤§è§„æ¨¡éƒ¨ç½²çš„ä¼˜åŒ–é…ç½®ï¼Œé˜²æ­¢å¹¿æ’­é£æš´ï¼š

**æœåŠ¡ç«¯é…ç½®**ï¼š
```json
{
  "mode": "server",
  "local_addr": "0.0.0.0:9000",
  "tunnel_addr": "10.0.0.1/24",
  "key": "your-strong-key",
  "multi_client": true,
  "max_clients": 100,
  "broadcast_throttle_ms": 1000,
  "enable_incremental_update": true,
  "max_peer_info_batch_size": 10,
  "route_advert_interval": 300,
  "p2p_keepalive_interval": 25
}
```

**å®¢æˆ·ç«¯é…ç½®**ï¼š
```json
{
  "mode": "client",
  "remote_addr": "server-ip:9000",
  "tunnel_addr": "10.0.0.2/24",
  "key": "your-strong-key",
  "route_advert_interval": 300,
  "p2p_keepalive_interval": 25
}
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- å¹¿æ’­æµé‡å‡å°‘ ~80%
- è·¯ç”±é€šå‘Šæµé‡å‡å°‘ 80%
- P2P ä¿æ´»æµé‡å‡å°‘ 40%
- æ€»ä½“æ§åˆ¶æµé‡å‡å°‘ ~60-70%

### å®‰å…¨é…ç½®

#### ç”Ÿæˆå¼ºå¯†é’¥

```bash
# ä½¿ç”¨ OpenSSL
openssl rand -base64 32

# æˆ–ä½¿ç”¨ /dev/urandom
head -c 32 /dev/urandom | base64
```

**æ¨è**ï¼š32-64 å­—ç¬¦ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦

#### é…ç½®æ–‡ä»¶æƒé™

```bash
# åˆ›å»ºé…ç½®ç›®å½•
sudo mkdir -p /etc/lightweight-tunnel

# è®¾ç½®æƒé™ï¼ˆä»… root å¯è¯»ï¼‰
sudo chmod 600 /etc/lightweight-tunnel/config.json
sudo chown root:root /etc/lightweight-tunnel/config.json
```

#### é˜²ç«å¢™é…ç½®

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 9000/tcp
sudo ufw allow 9000/udp

# CentOS/RHEL (firewalld)
sudo firewall-cmd --add-port=9000/tcp --permanent
sudo firewall-cmd --add-port=9000/udp --permanent
sudo firewall-cmd --reload

# iptables
sudo iptables -A INPUT -p tcp --dport 9000 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 9000 -j ACCEPT
```

---

## ğŸ” å¸¸è§é—®é¢˜

### å®‰è£…å’Œæƒé™

#### Q1: æƒé™é”™è¯¯ "permission denied"

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Raw Socketæ¨¡å¼éœ€è¦rootæƒé™è¿è¡Œ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ sudo
sudo ./lightweight-tunnel -m server ...

# æ–¹æ³• 2ï¼šæˆäºˆ capabilities
sudo setcap cap_net_raw,cap_net_admin=eip ./lightweight-tunnel
./lightweight-tunnel -m server ...
```

#### Q2: TUN è®¾å¤‡ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
/dev/net/tun: no such file or directory
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# åŠ è½½ TUN æ¨¡å—
sudo modprobe tun

# éªŒè¯
ls -l /dev/net/tun

# å¼€æœºè‡ªåŠ¨åŠ è½½
echo "tun" | sudo tee -a /etc/modules
```

### è¿æ¥é—®é¢˜

#### Q3: å®¢æˆ·ç«¯æ— æ³•è¿æ¥æœåŠ¡å™¨

**æ’æŸ¥æ­¥éª¤**ï¼š

1. **æ£€æŸ¥æœåŠ¡ç«¯è¿è¡ŒçŠ¶æ€**
```bash
sudo netstat -tulnp | grep 9000
# æˆ–
sudo ss -tulnp | grep 9000
```

2. **æ£€æŸ¥é˜²ç«å¢™**
```bash
sudo ufw status
sudo ufw allow 9000
```

3. **æµ‹è¯•è¿é€šæ€§**
```bash
ping <æœåŠ¡å™¨IP>
nc -zv <æœåŠ¡å™¨IP> 9000
```

4. **æŸ¥çœ‹æ—¥å¿—**
```bash
# æœåŠ¡ç«¯
sudo journalctl -u lightweight-tunnel-server -n 50

# å®¢æˆ·ç«¯
sudo ./lightweight-tunnel -m client ...  # æŸ¥çœ‹è¾“å‡º
```

#### Q4: å¯†é’¥ä¸åŒ¹é…

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Decryption error (wrong key?)
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ç¡®ä¿æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä½¿ç”¨**å®Œå…¨ç›¸åŒ**çš„ `-k` å‚æ•°
- âœ… å¯†é’¥åŒºåˆ†å¤§å°å†™
- âœ… æ³¨æ„ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
- âœ… ä½¿ç”¨å¼•å·åŒ…è£¹ï¼š`-k "my key with spaces"`
- âœ… æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„å¯†é’¥æ˜¯å¦ä¸€è‡´

### æ€§èƒ½å’Œé…ç½®

#### Q5: MTU åº”è¯¥è®¾ç½®å¤šå°‘ï¼Ÿ

**æ¨èé…ç½®**ï¼š

| åœºæ™¯ | MTU å€¼ | è¯´æ˜ |
|-----|--------|------|
| ä¸ç¡®å®š | `0` | è‡ªåŠ¨æ£€æµ‹ï¼ˆæ¨èï¼‰ |
| æ ‡å‡†ä»¥å¤ªç½‘ | `1371` | æœ€å¸¸è§åœºæ™¯ |
| ç§»åŠ¨ç½‘ç»œ/å¼±ç½‘ | `1200` | ä¿å®ˆé…ç½® |
| PPPoE ç½‘ç»œ | `1343` | DSL å®½å¸¦ |

```bash
# æœ€ç®€å•ï¼šè‡ªåŠ¨æ£€æµ‹
-mtu 0
```

#### Q6: å‘é€é˜Ÿåˆ—æ»¡é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Send queue full, dropping packet
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

é»˜è®¤é˜Ÿåˆ—å·²å¢åŠ åˆ° 5000ï¼Œå¹¶å®ç°äº†è¶…æ—¶ç­‰å¾…ã€‚å¦‚æœä»ç„¶å‡ºç°ï¼š

```bash
sudo ./lightweight-tunnel \
  -send-queue 10000 \
  -recv-queue 10000 \
  ...
```

### P2P å’Œé‡è¿

#### Q7: P2P è¿æ¥å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- âŒ åŒæ–¹éƒ½æ˜¯å¯¹ç§° NAT â†’ è‡ªåŠ¨å›é€€æœåŠ¡å™¨ä¸­è½¬
- âŒ é˜²ç«å¢™é˜»æ­¢ UDP â†’ æ£€æŸ¥å¹¶å¼€æ”¾ P2P ç«¯å£
- âŒ P2P ç«¯å£è¢«å ç”¨ â†’ æŒ‡å®šä¸åŒç«¯å£ï¼š`-p2p-port 19001`
- âŒ ç½‘ç»œä¸æ”¯æŒ UDP æ‰“æ´

> ğŸ’¡ **P2P å¤±è´¥ä¸å½±å“ä½¿ç”¨**ï¼šç¨‹åºä¼šè‡ªåŠ¨å›é€€åˆ°æœåŠ¡å™¨ä¸­è½¬æ¨¡å¼ã€‚

**éªŒè¯ P2P çŠ¶æ€**ï¼š
```bash
# åœ¨æ—¥å¿—ä¸­æŸ¥æ‰¾
Routing stats: X peers, Y direct, Z relay, W server
  Peer 10.0.0.X: route=P2P-DIRECT quality=100 status=connected
```

- `P2P-DIRECT` = P2P ç›´è¿æˆåŠŸ
- `SERVER-RELAY` = æœåŠ¡å™¨ä¸­è½¬

#### Q8: å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨é‡è¿å—ï¼Ÿ

**æ˜¯çš„ï¼** å®¢æˆ·ç«¯å†…ç½®è‡ªåŠ¨é‡è¿ï¼š

**å·¥ä½œæœºåˆ¶**ï¼š
- âœ… è‡ªåŠ¨æ£€æµ‹æ–­çº¿
- âœ… æŒ‡æ•°é€€é¿ï¼š1s â†’ 2s â†’ 4s â†’ 8s â†’ 16s â†’ 32sï¼ˆæœ€å¤§ï¼‰
- âœ… æ— é™é‡è¯•ç›´åˆ°æˆåŠŸ
- âœ… é‡è¿åç«‹å³æ¢å¤ï¼Œåº”ç”¨å±‚æ— æ„ŸçŸ¥
- âœ… P2P è¿æ¥ä¹Ÿä¼šè‡ªåŠ¨é‡å»º

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```
Network read error: connection refused, attempting reconnection...
Attempting to reconnect to server at 1.2.3.4:9000 (backoff 1s)
Reconnected to server: 10.0.0.2:54321 -> 1.2.3.4:9000
Reconnection successful, resuming packet reception
```

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… æœåŠ¡å™¨ä¸´æ—¶é‡å¯
- âœ… ç½‘ç»œä¸´æ—¶ä¸­æ–­
- âœ… é˜²ç«å¢™ä¸´æ—¶é˜»æ–­
- âœ… ç§»åŠ¨ç½‘ç»œåˆ‡æ¢

### ç›‘æ§å’Œè¯Šæ–­

#### Q9: å¦‚ä½•æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼Ÿ

**ç¨‹åºè¾“å‡º**ï¼š
```
=== Lightweight Tunnel ===
Version: 1.0.0
Mode: client
Transport: rawtcp (true TCP disguise)
ğŸ” Encryption: Enabled (AES-256-GCM)
MTU: 1371
Routing stats: 2 peers, 1 direct, 0 relay, 1 server
```

**ç³»ç»Ÿç›‘æ§å·¥å…·**ï¼š
```bash
# æŸ¥çœ‹ç½‘å¡æµé‡
sudo iftop -i tun0

# æŸ¥çœ‹ç½‘å¡ç»Ÿè®¡
ip -s link show tun0

# æŸ¥çœ‹è·¯ç”±è¡¨
ip route

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep lightweight-tunnel

# æŸ¥çœ‹ systemd æœåŠ¡
sudo systemctl status lightweight-tunnel-server
```

---

## ğŸ”’ å®‰å…¨å£°æ˜

### å®‰å…¨èƒ½åŠ›

**âœ… å¯ä»¥é˜²å¾¡**ï¼š
- é˜²æ­¢ ISP æŸ¥çœ‹æµé‡å†…å®¹ï¼ˆåŠ å¯†ï¼‰
- é˜²æ­¢ DPI è¯†åˆ«åè®®ç±»å‹ï¼ˆTCP ä¼ªè£…ï¼‰
- é˜²æ­¢æœªæˆæƒè¿æ¥ï¼ˆå¯†é’¥è®¤è¯ï¼‰
- é˜²æ­¢ä¸­é—´äººæ”»å‡»ï¼ˆGCM è®¤è¯åŠ å¯†ï¼‰

**âš ï¸ ä¸èƒ½é˜²å¾¡**ï¼š
- é«˜çº§æµé‡åˆ†æï¼ˆè¡Œä¸ºç‰¹å¾ã€æµé‡æ¨¡å¼ï¼‰
- ç«¯ç‚¹è¢«å…¥ä¾µ
- å¯†é’¥æ³„éœ²åçš„æ”»å‡»
- å®Œå…¨éšè—æ­£åœ¨ä½¿ç”¨ VPN/éš§é“çš„äº‹å®

### å®‰å…¨æœ€ä½³å®è·µ

| æ–¹é¢ | å»ºè®® |
|-----|------|
| **å¯†é’¥ç®¡ç†** | ä½¿ç”¨å¯†ç ç®¡ç†å™¨ç”Ÿæˆå’Œå­˜å‚¨å¯†é’¥<br>ä¸åœ¨å‘½ä»¤è¡Œç›´æ¥è¾“å…¥å¯†é’¥<br>å¯ç”¨è‡ªåŠ¨å¯†é’¥è½®æ¢ |
| **ç½‘ç»œéš”ç¦»** | æœåŠ¡ç«¯æ”¾åœ¨ä¸“ç”¨ VPS<br>ä½¿ç”¨é˜²ç«å¢™é™åˆ¶ç«¯å£å’Œ IP |
| **ç›‘æ§æ—¥å¿—** | å®šæœŸæ£€æŸ¥æ—¥å¿—æ–‡ä»¶<br>ç›‘æ§å¼‚å¸¸è¿æ¥å’Œæµé‡æ¨¡å¼ |
| **æ›´æ–°ç»´æŠ¤** | å®šæœŸæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬<br>ä½¿ç”¨ `./mupdate` å¿«é€Ÿæ›´æ–° |

### é‡è¦æç¤º

1. âš ï¸ **ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…å¯ç”¨åŠ å¯†**ï¼ˆ`-k` å‚æ•°ï¼‰
2. âš ï¸ **ä½¿ç”¨å¼ºå¯†ç ** - 32+ å­—ç¬¦ï¼ŒåŒ…å«å¤§å°å†™ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
3. âš ï¸ **å®šæœŸæ›´æ¢å¯†é’¥** - å»ºè®®æ¯ 3-6 ä¸ªæœˆæˆ–ä½¿ç”¨è‡ªåŠ¨è½®æ¢
4. âš ï¸ **ä¿æŠ¤é…ç½®æ–‡ä»¶** - è®¾ç½®é€‚å½“æƒé™ï¼ˆ600 æˆ– 640ï¼‰
5. âš ï¸ **ç›‘æ§å¼‚å¸¸æµé‡** - åŠæ—¶å‘ç°å®‰å…¨é—®é¢˜
6. âš ï¸ **é™åˆ¶æœåŠ¡å™¨è®¿é—®** - ä½¿ç”¨é˜²ç«å¢™è§„åˆ™

---

## ğŸ› ï¸ æŠ€æœ¯æ¶æ„

### é¡¹ç›®ç»“æ„

```
lightweight-tunnel/
â”œâ”€â”€ cmd/lightweight-tunnel/    # åº”ç”¨å…¥å£
â”‚   â””â”€â”€ main.go               # ä¸»å‡½æ•°ã€å‚æ•°è§£æ
â”œâ”€â”€ internal/config/          # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ config.go            # é…ç½®åŠ è½½/ä¿å­˜
â”œâ”€â”€ pkg/                      # å…¬å…±åŒ…
â”‚   â”œâ”€â”€ crypto/              # AES-256-GCM åŠ å¯†
â”‚   â”œâ”€â”€ faketcp/             # TCP ä¼ªè£…ï¼ˆRaw Socketï¼‰
â”‚   â”œâ”€â”€ rawsocket/           # åº•å±‚ Raw Socket æ“ä½œ
â”‚   â”œâ”€â”€ fec/                 # Reed-Solomon çº é”™
â”‚   â”œâ”€â”€ iptables/            # iptables è§„åˆ™ç®¡ç†
â”‚   â”œâ”€â”€ p2p/                 # P2P è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ nat/                 # NAT ç±»å‹æ£€æµ‹ï¼ˆSTUNï¼‰
â”‚   â”œâ”€â”€ routing/             # æ™ºèƒ½è·¯ç”±è¡¨
â”‚   â”œâ”€â”€ tunnel/              # éš§é“æ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ upnp/                # UPnP ç«¯å£æ˜ å°„
â”‚   â””â”€â”€ xdp/                 # eBPF/XDP åŠ é€Ÿ
â”œâ”€â”€ docs/                     # æ–‡æ¡£
â”œâ”€â”€ Makefile                  # æ„å»ºè„šæœ¬
â””â”€â”€ mupdate                   # ä¸€é”®æ›´æ–°è„šæœ¬
```

### æ ¸å¿ƒæŠ€æœ¯

#### ä¸ºä»€ä¹ˆä½¿ç”¨ Raw Socketï¼Ÿ

| æ–¹æ¡ˆ | å®ç° | æ•ˆæœ |
|-----|------|------|
| **UDP + å‡ TCP å¤´** | `[UDP Header (åè®®17)] [å‡ TCP å¤´] [æ•°æ®]` | âŒ å®¹æ˜“è¢«è¯†åˆ« |
| **Raw Socket + çœŸ TCP** | `[IP Header (åè®®6)] [çœŸ TCP Header] [æ•°æ®]` | âœ… å®Œç¾ä¼ªè£… |

**ä¼˜åŠ¿**ï¼š
- âœ… ç½‘ç»œå±‚å³ä¸ºçœŸå® TCPï¼ˆIP åè®®å· = 6ï¼‰
- âœ… å¯ç»•è¿‡ TCP-only é˜²ç«å¢™
- âœ… æ›´éš¾è¢« DPI æ£€æµ‹

**ä»£ä»·**ï¼š
- âš ï¸ éœ€è¦ root æƒé™

#### ä¸ºä»€ä¹ˆåŸºäº UDP æ ¸å¿ƒï¼Ÿ

é¿å… **TCP-over-TCP ç¾éš¾**ï¼š

```
TCP-over-TCP é—®é¢˜ï¼š
åº”ç”¨ TCP â”€â”
         â”œâ†’ åŒé‡é‡ä¼ ã€æ‹¥å¡æ§åˆ¶å†²çª â†’ æ€§èƒ½å´©æºƒ
éš§é“ TCP â”€â”˜

æœ¬é¡¹ç›®æ–¹æ¡ˆï¼š
åº”ç”¨æµé‡ â†’ FEC çº é”™ â†’ Raw TCP ä¼ªè£…
           â†“
        ä¸»åŠ¨çº é”™ï¼Œæ— é‡ä¼ ï¼Œä½å»¶è¿Ÿ
```

#### FEC å·¥ä½œåŸç†

Reed-Solomon ç¼–ç å®ç°å‰å‘çº é”™ï¼š

```
ç¼–ç ï¼š[D1]...[D10] â†’ åŠ æ ¡éªŒ â†’ [D1]...[D10][P1][P2][P3]
è§£ç ï¼š[D1][ Ã—][D3]...[D10][P1][P2][P3] â†’ æ¢å¤ â†’ [D1][D2][D3]...[D10]
```

**ä¼˜åŠ¿**ï¼šæ— éœ€é‡ä¼ ï¼Œé™ä½å»¶è¿Ÿï¼Œé€‚åˆå®æ—¶åº”ç”¨

#### P2P å»ºç«‹æµç¨‹

```
æ­¥éª¤1ï¼šå®¢æˆ·ç«¯æ³¨å†Œ    A â†’ [Server] â† B
æ­¥éª¤2ï¼šäº¤æ¢ä¿¡æ¯      A â† [Server] â†’ B
æ­¥éª¤3ï¼šåŒæ—¶æ‰“æ´      A â”€â”€UDPæ‰“æ´â”€â”€â†’ B  (ä½¿ç”¨UDPåè®®)
æ­¥éª¤4ï¼šP2P å»ºç«‹      A â†â”€â”€ç›´è¿â”€â”€â†’ B

æŠ€æœ¯è¯´æ˜ï¼š
- ä¸»éš§é“(Serverâ†”Client): ä½¿ç”¨Raw Socket TCPä¼ªè£…æŠ€æœ¯
- P2Pè¿æ¥(Clientâ†”Client): ä½¿ç”¨UDPæ‰“æ´æŠ€æœ¯
- ä¸ºä»€ä¹ˆP2Pç”¨UDPä¸ç”¨TCPï¼šTCPæ‰“æ´æˆåŠŸç‡<5%ï¼ŒUDPæ‰“æ´æˆåŠŸç‡60-95%
```

**NAT å…¼å®¹**ï¼šé€šè¿‡ç«¯å£é¢„æµ‹æ”¯æŒå¯¹ç§° NATï¼ˆ70-80% æˆåŠŸç‡ï¼‰

**å…³é”®æŠ€æœ¯ç‰¹æ€§**ï¼š
- âœ… STUNåè®®è‡ªåŠ¨æ£€æµ‹NATç±»å‹
- âœ… æ™ºèƒ½ç«¯å£é¢„æµ‹ç®—æ³•ï¼ˆä¼˜å…ˆé¡ºåºåˆ†é…Â±10ï¼Œæ‰©å±•Â±50èŒƒå›´ï¼‰
- âœ… è‡ªé€‚åº”æ¡æ‰‹ç­–ç•¥ï¼ˆ50mså¿«é€Ÿå°è¯•30æ¬¡ï¼‰
- âœ… è¿ç»­ä¿æ´»æœºåˆ¶ï¼ˆå»ºç«‹æœŸ3ç§’ï¼Œç¨³å®šå10ç§’å¯é…ç½®ï¼‰
- âœ… å¤±è´¥è‡ªåŠ¨å›é€€åˆ°æœåŠ¡å™¨ä¸­è½¬ï¼ˆæ— ç¼åˆ‡æ¢ï¼‰

### å¼€å‘ä¸è´¡çŒ®

#### å¼€å‘ç¯å¢ƒ

```bash
# å®‰è£… Go 1.19+
wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin

# é…ç½®ä»£ç†ï¼ˆä¸­å›½å¤§é™†ç”¨æˆ·ï¼‰
go env -w GOPROXY=https://goproxy.cn,direct

# å®‰è£…å¼€å‘å·¥å…·
go install golang.org/x/tools/cmd/goimports@latest
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
```

#### è´¡çŒ®æŒ‡å—

æ¬¢è¿æ‰€æœ‰å½¢å¼çš„è´¡çŒ®ï¼

1. **æŠ¥å‘Šé—®é¢˜**ï¼šåœ¨ GitHub Issues æäº¤ bug å’Œå»ºè®®
2. **æäº¤ä»£ç **ï¼š
   - Fork ä»“åº“å¹¶åˆ›å»ºç‰¹æ€§åˆ†æ”¯
   - ç¼–å†™æ¸…æ™°çš„æäº¤ä¿¡æ¯
   - ç¡®ä¿æµ‹è¯•é€šè¿‡
   - æäº¤ Pull Request
3. **ä»£ç è§„èŒƒ**ï¼šéµå¾ª Go æ ‡å‡†æ ¼å¼ï¼ˆ`gofmt`ï¼‰

---

## ğŸ“š å‚è€ƒèµ„æº

### ç›¸å…³é¡¹ç›®

æœ¬é¡¹ç›®å‚è€ƒäº†ä»¥ä¸‹ä¼˜ç§€å¼€æºé¡¹ç›®ï¼š

- [**udp2raw**](https://github.com/wangyu-/udp2raw) - UDP ä¼ªè£…ä¸º TCPï¼Œæœ¬é¡¹ç›® Raw Socket å®ç°çš„çµæ„Ÿæ¥æº
- [**tinyfecVPN**](https://github.com/wangyu-/tinyfecVPN) - è½»é‡çº§ FEC VPNï¼ŒFEC æ¨¡å—å‚è€ƒ
- [**n2n**](https://github.com/ntop/n2n) - P2P VPNï¼ŒP2P æ¶æ„å‚è€ƒ

### æŠ€æœ¯æ–‡æ¡£

- [Go è¯­è¨€å®˜æ–¹æ–‡æ¡£](https://go.dev/doc/)
- [Linux Raw Socket](https://man7.org/linux/man-pages/man7/raw.7.html)
- [TCP/IP åè®®è¯¦è§£](https://www.rfc-editor.org/rfc/rfc793)
- [Reed-Solomon çº é”™ç ](https://en.wikipedia.org/wiki/Reed%E2%80%93Solomon_error_correction)
- [STUN åè®® RFC 5389](https://www.rfc-editor.org/rfc/rfc5389)

---

## ğŸ“„ å¼€æºåè®®

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](LICENSE) å¼€æºåè®®ã€‚

è¯¦ç»†åè®®å†…å®¹è¯·æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

---

## ğŸ“ è”ç³»æ–¹å¼

- **GitHub Issues**: [æäº¤é—®é¢˜æˆ–å»ºè®®](https://github.com/openbmx/lightweight-tunnel/issues)
- **Pull Requests**: [è´¡çŒ®ä»£ç ](https://github.com/openbmx/lightweight-tunnel/pulls)
- **Discussions**: [è®¨è®ºåŒº](https://github.com/openbmx/lightweight-tunnel/discussions)

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹å¼€æºé¡¹ç›®å’Œè´¡çŒ®è€…ï¼š

- **udp2raw** - TCP ä¼ªè£…å®ç°æ€è·¯
- **tinyfecVPN** - FEC å®ç°å‚è€ƒ
- **n2n** - P2P ç½‘ç»œæ¶æ„å‚è€ƒ
- æ‰€æœ‰ä¸ºæœ¬é¡¹ç›®è´¡çŒ®ä»£ç å’Œå»ºè®®çš„å¼€å‘è€…

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (å½“å‰ç‰ˆæœ¬)

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ¨ Raw Socket çœŸå® TCP ä¼ªè£…
- âœ¨ å¤šå®¢æˆ·ç«¯ Hub æ¨¡å¼
- âœ¨ P2P ç›´è¿å’Œ NAT ç©¿é€
- âœ¨ AES-256-GCM åŠ å¯†
- âœ¨ è‡ªåŠ¨ MTU æ£€æµ‹
- âœ¨ FEC å‰å‘çº é”™
- âœ¨ è‡ªåŠ¨é‡è¿æœºåˆ¶
- âœ¨ åŠ¨æ€å¯†é’¥è½®æ¢
- âœ¨ è·¯ç”±å®£å‘ŠåŠŸèƒ½
- âœ¨ systemd æœåŠ¡æ”¯æŒ

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- ğŸš€ é˜Ÿåˆ—ä» 1000 å¢åŠ åˆ° 5000
- ğŸš€ æ”¹è¿› P2P è¿æ¥å’Œ NAT æ£€æµ‹
- ğŸš€ å¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—
- ğŸš€ ä¼˜åŒ–é‡è¿ç­–ç•¥

**é—®é¢˜ä¿®å¤**ï¼š
- ğŸ› ä¿®å¤é˜Ÿåˆ—æ»¡å¯¼è‡´çš„ä¸¢åŒ…
- ğŸ› ä¿®å¤ P2P è¿æ¥æ—¶åºé—®é¢˜
- ğŸ› ä¿®å¤åŠ å¯†æ•°æ®åŒ…åˆ†ç‰‡é—®é¢˜

---

<div align="center">

**æ„Ÿè°¢ä½¿ç”¨ Lightweight Tunnelï¼**

å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ª â­ Starï¼

Made with â¤ï¸ by the Lightweight Tunnel Team

[â¬† è¿”å›é¡¶éƒ¨](#lightweight-tunnel---è½»é‡çº§éš§é“)

</div>
