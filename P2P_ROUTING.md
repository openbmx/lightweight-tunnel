# P2P和智能路由功能 (P2P and Intelligent Routing Features)

## 概述 (Overview)

lightweight-tunnel 现在支持 **P2P 直连**和**智能路由选择**功能，可以在客户端之间建立直接连接，无需通过服务器中转。当 P2P 连接不佳或无法建立时，系统会自动选择最优路径，包括通过其他客户端中继或回退到服务器转发。

## 核心特性 (Core Features)

### 1. P2P 直连 (Direct P2P Connections)

- **无服务器中转**: 客户端之间可以直接通信，减少延迟和服务器负载
- **NAT 穿透**: 使用 UDP 打洞技术穿透 NAT 设备
- **自动建立**: 通过服务器交换地址信息，自动尝试建立 P2P 连接
- **加密支持**: P2P 连接可以使用相同的加密机制

### 2. 智能路由选择 (Intelligent Route Selection)

系统会根据以下因素自动选择最佳路径：

- **连接质量评分** (0-100分):
  - 延迟: 每10ms扣5分
  - 丢包率: 1%丢包扣10分
  - P2P直连: 加20分
  - 服务器转发: 扣30分

- **路由类型优先级**:
  1. **直连路由** (RouteDirect): P2P 直接连接
  2. **中继路由** (RouteRelay): 通过其他客户端中继
  3. **服务器路由** (RouteServer): 通过服务器转发

### 3. 网状路由 (Mesh Routing)

- **多跳转发**: 支持通过其他客户端中继流量
- **最大跳数限制**: 可配置最大跳数（默认3跳）
- **自动路径发现**: 动态发现可用的中继路径
- **负载均衡**: 选择质量最佳的中继节点

### 4. 自动故障切换 (Automatic Failover)

当连接出现问题时，自动切换到备用路径：

```
P2P 连接失败 → 尝试中继路由 → 回退到服务器路由
```

## 配置说明 (Configuration)

### 命令行参数

```bash
# P2P 相关参数
-p2p                  # 启用 P2P 功能 (默认: true)
-p2p-port int         # P2P UDP 端口 (默认: 0 自动选择)
-mesh-routing         # 启用网状路由 (默认: true)
-max-hops int         # 最大跳数 (默认: 3)
-route-update int     # 路由更新间隔秒数 (默认: 30)
```

### JSON 配置文件

```json
{
  "mode": "client",
  "remote_addr": "server.example.com:9000",
  "tunnel_addr": "10.0.0.2/24",
  "p2p_enabled": true,
  "p2p_port": 0,
  "enable_mesh_routing": true,
  "max_hops": 3,
  "route_update_interval": 30,
  "p2p_timeout": 5
}
```

### 配置选项说明

| 选项 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `p2p_enabled` | bool | true | 启用 P2P 直连功能 |
| `p2p_port` | int | 0 | UDP 端口，0表示自动选择 |
| `enable_mesh_routing` | bool | true | 启用网状路由 |
| `max_hops` | int | 3 | 最大允许跳数 |
| `route_update_interval` | int | 30 | 路由质量检查间隔（秒） |
| `p2p_timeout` | int | 5 | P2P 连接超时（秒） |

## 使用示例 (Usage Examples)

### 场景 1: 启用 P2P 的多客户端网络

**服务器:**
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24
```

**客户端 1:**
```bash
sudo ./lightweight-tunnel -m client -r server.example.com:9000 -t 10.0.0.2/24 -p2p
```

**客户端 2:**
```bash
sudo ./lightweight-tunnel -m client -r server.example.com:9000 -t 10.0.0.3/24 -p2p
```

**客户端 3:**
```bash
sudo ./lightweight-tunnel -m client -r server.example.com:9000 -t 10.0.0.4/24 -p2p
```

连接建立后，客户端会：
1. 首先通过服务器交换地址信息
2. 自动尝试建立 P2P 直连
3. 成功后流量直接走 P2P，不经过服务器
4. 如果 P2P 失败，自动回退到服务器转发

### 场景 2: 仅使用服务器转发（禁用 P2P）

如果网络环境不支持 P2P 或者需要强制所有流量通过服务器：

```bash
sudo ./lightweight-tunnel -m client -r server.example.com:9000 -t 10.0.0.2/24 -p2p=false
```

### 场景 3: 自定义 P2P 端口

如果需要指定固定的 P2P 端口（例如防火墙规则）：

```bash
sudo ./lightweight-tunnel -m client -r server.example.com:9000 -t 10.0.0.2/24 -p2p-port 10000
```

### 场景 4: 禁用网状路由

如果只想使用直连或服务器转发，不使用其他客户端中继：

```bash
sudo ./lightweight-tunnel -m client -r server.example.com:9000 -t 10.0.0.2/24 -mesh-routing=false
```

## 工作原理 (How It Works)

### 1. 连接建立流程

```
客户端 A                服务器                客户端 B
   |                     |                     |
   |------ 连接 -------->|<------ 连接 ---------|
   |                     |                     |
   |<--- 地址交换 ------->|<--- 地址交换 ------->|
   |                     |                     |
   |<======= P2P 握手 (UDP 打洞) =========>|
   |                     |                     |
   |<======= P2P 数据传输 ===============>|
   |                     |                     |
```

### 2. 路由决策流程

每个数据包发送前，系统会：

1. **检查路由表**: 查找目标 IP 的最佳路由
2. **评估路由质量**: 
   - 直连 P2P: 优先级最高
   - 中继路由: 次优先级
   - 服务器转发: 保底方案
3. **选择路径**: 选择质量评分最高的路径
4. **发送数据**: 通过选定路径发送
5. **监控质量**: 持续监控连接质量
6. **动态切换**: 质量下降时自动切换路径

### 3. NAT 穿透机制

使用 UDP 打洞技术穿透 NAT：

1. 客户端通过服务器交换公网地址
2. 同时向对方地址发送握手包
3. NAT 设备为 UDP 流创建映射
4. 握手成功后建立 P2P 连接

### 4. 路由质量监控

系统定期（默认30秒）更新路由信息：

- 测量延迟: 通过 ping/pong 机制
- 统计丢包: 跟踪发送/接收包数
- 计算评分: 根据质量指标打分
- 更新路由表: 重新选择最佳路径

## 网络拓扑示例 (Network Topology Examples)

### Hub 模式 + P2P

```
                    服务器 (10.0.0.1)
                    用于地址交换和故障转移
                          |
         ┌────────────────┼────────────────┐
         │                │                │
    客户端 A          客户端 B          客户端 C
   (10.0.0.2)        (10.0.0.3)        (10.0.0.4)
         │                │                │
         └════════════════╪════════════════┘
                  P2P 直连连接
```

### 网状路由

```
                    服务器 (10.0.0.1)
                          |
         ┌────────────────┼────────────────┐
         │                │                │
    客户端 A ═══════════ 客户端 B          客户端 C
   (10.0.0.2)   直连   (10.0.0.3)        (10.0.0.4)
         │                │                │
         └════════════════╪════════════════┘
                       中继连接
         (A → C 可以通过 B 中继)
```

## 性能特点 (Performance Characteristics)

### P2P 直连 vs 服务器转发

| 指标 | P2P 直连 | 服务器转发 |
|------|----------|-----------|
| 延迟 | ~1-5 ms | ~10-50 ms |
| 带宽 | 点对点全速 | 受服务器带宽限制 |
| 服务器负载 | 极低 | 正常 |
| NAT 要求 | 支持 UDP | 仅需 TCP |

### 适用场景

**适合使用 P2P:**
- 客户端在相同地理位置
- 需要低延迟通信
- 大量数据传输
- 减轻服务器负担

**适合使用服务器转发:**
- 严格的防火墙策略
- 对称型 NAT 环境
- 客户端地理位置分散
- 需要集中审计

## 故障排除 (Troubleshooting)

### P2P 连接失败

**症状**: 日志显示 P2P 连接失败，流量回退到服务器

**可能原因**:
1. **防火墙阻止 UDP**: 确保 UDP 端口开放
2. **对称型 NAT**: 某些 NAT 类型不支持打洞
3. **网络策略**: 公司网络可能阻止 P2P 连接

**解决方案**:
```bash
# 1. 检查 UDP 端口是否开放
sudo ufw allow 10000/udp

# 2. 指定固定端口并配置端口转发
./lightweight-tunnel -m client -p2p-port 10000 ...

# 3. 如果完全无法使用 P2P，禁用它
./lightweight-tunnel -m client -p2p=false ...
```

### 路由不稳定

**症状**: 连接频繁切换路径，不稳定

**解决方案**:
```bash
# 增加路由更新间隔，减少切换频率
./lightweight-tunnel -m client -route-update 60 ...
```

### 查看路由状态

日志会定期显示路由统计信息：

```
Routing stats: 3 peers, 2 direct, 0 relay, 1 server
```

含义：
- `3 peers`: 总共3个对等节点
- `2 direct`: 2个直连路由
- `0 relay`: 0个中继路由
- `1 server`: 1个服务器路由

## 安全考虑 (Security Considerations)

### P2P 加密

P2P 连接默认不加密数据。如果需要加密：

1. **应用层加密**: 在应用层使用 TLS/SSL
2. **VPN 套娃**: 在隧道之上再建立 VPN
3. **未来功能**: 计划添加 P2P 层面的加密

### 防火墙规则

P2P 模式需要开放 UDP 端口：

```bash
# 允许特定端口
sudo ufw allow 10000/udp

# 或允许端口范围
sudo ufw allow 10000:10100/udp
```

### 中继安全

使用网状路由时，其他客户端可以看到通过它们中继的流量。建议：

- 只在可信网络中启用网状路由
- 使用应用层加密
- 或禁用中继功能: `-mesh-routing=false`

## 未来增强 (Future Enhancements)

计划中的功能：

1. **P2P 加密**: 端到端加密 P2P 连接
2. **更多 NAT 穿透技术**: STUN/TURN 支持
3. **带宽管理**: QoS 和流量控制
4. **智能预测**: 基于历史数据预测最佳路由
5. **多路径传输**: 同时使用多条路径提高可靠性
6. **IPv6 支持**: 完整的 IPv6 支持

## 技术细节 (Technical Details)

### 数据包类型

新增的数据包类型：

```go
PacketTypePeerInfo  = 0x03 // 对等节点信息交换
PacketTypeRouteInfo = 0x04 // 路由信息交换
```

### 路由评分算法

```
基础分 = 100

延迟惩罚 = (延迟毫秒 / 10) * 5
丢包惩罚 = 丢包率 * 1000
P2P 奖励 = 20 (如果是直连)
服务器惩罚 = 30 (如果通过服务器)

最终分数 = max(0, min(100, 基础分 - 延迟惩罚 - 丢包惩罚 + P2P 奖励 - 服务器惩罚))
```

### 数据结构

核心数据结构：

- `PeerInfo`: 对等节点信息
- `Route`: 路由条目
- `RoutingTable`: 路由表
- `Manager`: P2P 连接管理器

## 总结 (Summary)

P2P 和智能路由功能为 lightweight-tunnel 带来：

✅ **降低延迟**: P2P 直连消除服务器中转延迟
✅ **提高带宽**: 点对点传输不受服务器带宽限制
✅ **增强可靠性**: 多路径自动故障切换
✅ **减轻负载**: 减少服务器流量和 CPU 负载
✅ **灵活部署**: 支持各种网络拓扑和需求

通过智能路由选择，系统能够自动在 P2P、中继和服务器转发之间选择最优路径，在保证连接质量的同时提供最佳性能。
