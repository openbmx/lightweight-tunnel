#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$REPO_DIR"

if [ ! -d "$REPO_DIR/.git" ]; then
  echo "This script must be run from the lightweight-tunnel git repository root."
  exit 1
fi

echo "Pulling latest changes..."
if ! git pull; then
  echo "git pull failed. Please ensure the repository is clean, resolve any merge conflicts, and verify network connectivity before rerunning this script."
  exit 1
fi

echo "Building lightweight-tunnel..."
if ! make build; then
  echo "Build failed. Ensure Go is installed and dependencies are available, then rerun this script."
  exit 1
fi

BIN_PATH="$REPO_DIR/bin/lightweight-tunnel"
TARGET="/usr/local/bin/lightweight-tunnel"

if [ ! -f "$BIN_PATH" ]; then
  echo "Build output not found at $BIN_PATH"
  exit 1
fi

INSTALLER=""
if [ -w "$(dirname "$TARGET")" ]; then
  INSTALLER="install -m 755"
elif command -v sudo >/dev/null 2>&1; then
  INSTALLER="sudo install -m 755"
else
  echo "Cannot install to $TARGET: insufficient permissions and sudo is not available."
  exit 1
fi

echo "Installing binary to $TARGET (may prompt for sudo)..."
$INSTALLER "$BIN_PATH" "$TARGET"
echo "Update completed."
