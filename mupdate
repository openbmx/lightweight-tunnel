#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$REPO_DIR"

if [ ! -d "$REPO_DIR/.git" ]; then
  echo "This script must be run from the repository root (directory containing .git)."
  exit 1
fi

if [ -n "$(git status --porcelain)" ]; then
  echo "Working tree has local changes. Please commit or stash them before running mupdate."
  exit 1
fi

echo "Pulling latest changes..."
if ! git pull --ff-only; then
  echo "git pull failed. This may be due to branch divergence or network issues. Please resolve and rerun."
  exit 1
fi

echo "Building lightweight-tunnel..."
if ! make build; then
  echo "Build failed. Ensure Go is installed and dependencies are available, then rerun this script."
  exit 1
fi

BIN_PATH="$REPO_DIR/bin/lightweight-tunnel"
TARGET="/usr/local/bin/lightweight-tunnel"

if [ ! -f "$BIN_PATH" ]; then
  echo "Build output not found at $BIN_PATH"
  exit 1
fi

echo "Installing binary to $TARGET..."
if ! install -m 755 "$BIN_PATH" "$TARGET"; then
  install_error="Installation failed. Please check permissions for $TARGET."
  if command -v sudo >/dev/null 2>&1; then
    echo "Retrying with sudo..."
    sudo install -m 755 "$BIN_PATH" "$TARGET" || { echo "$install_error"; exit 1; }
  else
    echo "$install_error Sudo is not available."
    exit 1
  fi
fi
echo "Update completed."
restart_msg="Restart the lightweight-tunnel systemd service to load the new binary."
restart_example_template="For example: sudo systemctl restart %s (or your custom service name, such as lightweight-tunnel-server)."
default_service="lightweight-tunnel"
running_service=""
systemctl_output=""
if command -v systemctl >/dev/null 2>&1; then
  systemctl_output=$(systemctl list-units --type=service --state=active 'lightweight-tunnel*' --no-legend --no-pager --plain 2>/dev/null || true)
  running_service=$(printf "%s" "$systemctl_output" | awk '{print $1}' | head -n1)
  running_service=${running_service%.service}
fi
if [ -n "$running_service" ]; then
  echo "Detected running lightweight-tunnel systemd service: $running_service"
  echo "$restart_msg"
  echo "sudo systemctl restart $running_service"
else
  echo "If a lightweight-tunnel systemd service is running:"
  echo "$restart_msg"
  printf "$restart_example_template\n" "${running_service:-$default_service}"
fi
